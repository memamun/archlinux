"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[17586,46414],{191458:(e,t,n)=>{n.r(t),n.d(t,{loadWorkflowTemplateInstances:()=>l});n(944114),n(581454);var o=()=>n(912720),r=()=>n(534177),i=()=>n(630116);const c=!1;function l(e){const t=[];let n=!1;e.isDefined()||(n=!0);const l=e=>{var o;if(!e.isDefined())return void(n=!0);const r=null===(o=e.getProperties())||void 0===o?void 0:o.workflow_template_instance;r&&t.push({instancePointer:{type:"automation",id:e.id,spaceId:e.getSpaceId()},templateId:r.template_id})},a=e.getFormat().workflow_template_instance,s=e.getParentBlockStore();if(null==s||!s.isDefined())return{isLoading:!0,instances:[]};a&&t.push({instancePointer:{type:"collection",id:e.id},templateId:a.template_id});const p=s.getCollectionViewStores()??[];for(const o of p){if(!o.isDefined()){n=!0;continue}const e=o.getFormat().workflow_template_instance;e&&t.push({instancePointer:{type:"collection_view",id:o.id},templateId:e.template_id})}const d=e.getLayoutStore();if(d)if(d.isDefined()){var m;const e=null===(m=d.getFormat())||void 0===m?void 0:m.workflow_template_instance;e&&t.push({instancePointer:{type:"layout",id:d.id,spaceId:d.getSpaceId()},templateId:e.template_id})}else n=!0;const u=e.getTemplatePageStores();for(const o of u){const e=o.getModel();if(!e){n=!0;continue}if(!e.isPageBlock())continue;const r=e.getFormat().workflow_template_instance;r&&t.push({instancePointer:{type:"block",id:e.id,spaceId:e.getSpaceId()},templateId:r.template_id});const i=o.getAutomationStore();i&&l(i)}const f=e.getAutomationStores();for(const o of f)l(o);const y=e.getSpaceId(),I=e.getSchema();for(const[r,c]of Object.entries(I)){if(!c)continue;const n=c.workflow_template_instance;if(n&&t.push({instancePointer:{type:"property",id:r,collectionId:e.id},templateId:n.template_id}),"button"===c.type&&c.automation_id){l(i().dn.createChildStore(e,{id:c.automation_id,spaceId:y,table:o().yB}))}}const g=e.getFormat().compound_workflow_template_instances??[];for(const o of g)t.push({instancePointer:{type:"compound",id:o.id,collectionId:e.id,instancePointers:o.instance_pointers.map((t=>{switch(t.type){case"automation":return{type:"automation",id:t.id,spaceId:y};case"block":return{type:"block",id:t.id,spaceId:y};case"collection_view":return{type:"collection_view",id:t.id};case"layout":return{type:"layout",id:t.id,spaceId:y};case"property":return{type:"property",id:t.id,collectionId:e.id}}(0,r().HB)(t)}))},templateId:o.template_id});return c&&console.log("loadWorkflowTemplateInstances: loaded workflow template instances for collection:",e.id,"isLoading:",n,"instances:",t),{isLoading:n,instances:t}}},204067:(e,t,n)=>{n.d(t,{CB:()=>k,DM:()=>L,FE:()=>F,Fy:()=>O,NU:()=>W,R5:()=>z,S1:()=>B,Sl:()=>S,TE:()=>b,Xg:()=>j,Zp:()=>A,aI:()=>E,aL:()=>q,b3:()=>h,fI:()=>M,ju:()=>T,rS:()=>D,tY:()=>$,wW:()=>R});n(16280),n(944114),n(898992),n(354520),n(672577),n(430670),n(581454),n(737550);var o=()=>n(888325),r=()=>n(663077),i=()=>n(857639),c=()=>n(912720),l=()=>n(179034),a=()=>n(519831),s=()=>n(869558),p=()=>n(144081),d=()=>n(496603),m=()=>n(534177),u=()=>n(108944),f=()=>n(630116),y=()=>n(299177),I=()=>n(191458),g=()=>n(913454);const v=!1;function h(e){const t={};for(const n of e){const e=t[n.templateId]??[];e.push(n.instancePointer),t[n.templateId]=e}return t}function w(e){let t;if("collection"===e.table)t=h((0,I().loadWorkflowTemplateInstances)(e).instances);else{const n=(0,o()._)(e.pointer),r=y().A.getState();t=(null==r?void 0:r[n])??{}}const n=T(t);return v&&(console.groupCollapsed("getTemplateIdToInstancePointersMap",e.pointer),console.trace(),console.log("Raw map:",t),console.log("Map with invalid template IDs removed:",n),console.groupEnd()),n}function T(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:g().globalWorkflowTemplates;const n={},o=(0,d().Bj)((e=>{try{return t.fromId(e),!0}catch(n){return!1}}));for(const[r,i]of Object.entries(e))o(r)&&(n[r]=i);return n}function S(e){let{environment:t,collectionStore:n}=e;const o=w(n),r=[];for(const[i,c]of Object.entries(o))for(const e of c)E({environment:t,instancePointer:e,inMemoryRecordCache:n.inMemoryRecordCache})&&r.push({instancePointer:e,templateId:i});return r}const P="dependency_";function b(e){return e.startsWith(P)}function k(e){let{collectionStore:t,sourceTemplateType:n,sourcePrimitiveId:o,dependencyMap:r}=e;const i=_({sourceTemplateType:n,sourcePrimitiveId:o,dependencyMap:r});if(!i)return o;const c=C(t,i);if(0===c.length)return`${P}${i}`;return c[c.length-1].id}function M(e){let{collectionStore:t,sourceTemplateType:n,sourcePrimitiveId:o,dependencyMap:r}=e;const i=_({sourceTemplateType:n,sourcePrimitiveId:o,dependencyMap:r});if(!i)return;const c=C(t,i);if(0===c.length)return;return c[c.length-1].id}function _(e){let{sourceTemplateType:t,sourcePrimitiveId:n,dependencyMap:o}=e;if(b(n))return n.replace(P,"");return o[(0,r().Ir)(t,n)]}function C(e,t){return w(e)[t]??[]}function R(e){let{environment:t,spaceStore:n,templateId:o}=e;return C(n,o).filter((e=>E({environment:t,instancePointer:e,inMemoryRecordCache:n.inMemoryRecordCache})))}function B(e){let{collectionStore:t,templateId:n,instancePointerType:o}=e;const r=C(t,n);if(0===r.length)return;const i=r[r.length-1];if(i.type!==o)throw new Error(`Expect to find instance pointer type ${o} for template ID ${n} but found ${i.type} instead`);return i}function W(e){let{environment:t,collectionStore:n,templateId:o}=e;return Boolean(A({environment:t,scopeStore:n,templateId:o}))}function A(e){let{environment:t,scopeStore:n,templateId:o}=e;const r=n.pointer,c=C(n,o).filter((e=>E({environment:t,instancePointer:e,inMemoryRecordCache:n.inMemoryRecordCache}))),l=(0,d().hS)(c,(e=>e.id));if(l.length!==c.length){const e=c.map((e=>e.id));i().log({level:"warning",from:"workflowTemplatesInstanceHelpers",type:"duplicateAliveInstancePointers",data:{miscDataToConvertToString:{templateId:o,instanceIds:e}}})}return 0===l.length?void 0:l.length>1?(i().log({level:"warning",from:"workflowTemplatesInstanceHelpers",type:"moreThanOneAliveInstancePointer",data:{miscDataToConvertToString:{templateId:o,scope:r,uniqueAliveInstancePointers:l}}}),l[0]):l[0]}function E(e){let{environment:t,instancePointer:n,inMemoryRecordCache:o}=e;if("property"===n.type){const e=new(f().md)(t,{table:a().Vl,id:n.collectionId},{inMemoryRecordCache:o});return Boolean(e.getSchema()[n.id])}if("collection_view"===n.type){const e=new(f().pS)(t,{table:s().Gy,id:n.id},{inMemoryRecordCache:o});return Boolean(e.getAlive())}if("collection"===n.type){const e=new(f().md)(t,{table:a().Vl,id:n.id},{inMemoryRecordCache:o});return!(0,u().ze)(e)}if("layout"===n.type){const e=new(f().K_)(t,{table:p().zx,id:n.id,spaceId:n.spaceId},{inMemoryRecordCache:o});return!(0,u().ze)(e)}if("compound"===n.type)return function(e){let{environment:t,instancePointer:n,inMemoryRecordCache:o}=e;return n.instancePointers.some((e=>E({environment:t,instancePointer:e,inMemoryRecordCache:o})))}({environment:t,instancePointer:n,inMemoryRecordCache:o});if("block"===n.type){const e=new(f().Bv)(t,{table:l().ev,id:n.id,spaceId:n.spaceId},{inMemoryRecordCache:o});return!(0,u().ze)(e)}if("automation"===n.type){const e=new(f().dn)(t,{table:c().yB,id:n.id,spaceId:n.spaceId},{inMemoryRecordCache:o});return!(0,u().ze)(e)}(0,m().HB)(n)}function j(e,t){const n=w(t);return Object.keys(n).filter((n=>W({environment:e,collectionStore:t,templateId:n}))).map((e=>g().globalWorkflowTemplates.fromId(e)))}function D(e,t){const n=[],o=w(e);for(const r of Object.values(o))n.push(...r.filter((e=>e.type===t)));return n}function $(e){let{environment:t,collectionStore:n}=e;if(!n)return;const o=S({environment:t,collectionStore:n}).filter((e=>{let{instancePointer:t}=e;return"collection"===t.type&&t.id===n.id}));if(0!==o.length){if(o.length>1)throw new Error(`More than one collection preset templates found for collection ${n.id}`);return g().globalWorkflowTemplates.fromIdOfType({templateId:o[0].templateId,type:"collection"})}}function L(e){const{type:t}=e;return"collection_view"===t||"property"===t||"layout"===t||"compound"===t||"block"===t||"automation"===t}function F(e){let{environment:t,collectionStore:n}=e;return S({environment:t,collectionStore:n}).filter((e=>"compound"===e.instancePointer.type))}function O(e){let{environment:t,collectionStore:n,instancePointerId:o}=e;const r=S({environment:t,collectionStore:n}).find((e=>e.instancePointer.id===o));if(r)return g().globalWorkflowTemplates.featureFromId(r.templateId)}function x(e){let{environment:t,collectionStore:n,propertyId:o}=e;const r=function(e){let{environment:t,collectionStore:n,propertyId:o}=e;return S({environment:t,collectionStore:n}).filter((e=>"property"===e.instancePointer.type&&e.instancePointer.id===o))}({collectionStore:n,environment:t,propertyId:o}),i=F({environment:t,collectionStore:n}).filter((e=>{let{instancePointer:t}=e;return r.some((e=>t.instancePointers.some((t=>t.id===e.instancePointer.id))))}));return{propertyTemplateInstances:r,compoundTemplateInstances:i}}function z(e){let{collectionStore:t,environment:n,propertyId:o}=e;const{propertyTemplateInstances:i,compoundTemplateInstances:c}=x({environment:n,collectionStore:t,propertyId:o}),l=i.map((e=>{let{templateId:t}=e;return g().globalWorkflowTemplates.fromId(t)})).filter((e=>(0,r().Xq)(e,"property")));return c.filter((e=>{let{templateId:t}=e;const n=g().globalWorkflowTemplates.fromId(t);if((0,r().Xq)(n,"compound"))return l.some((e=>n.value.templateItems.some((t=>t.pointer===e.templateId&&"required"===t.optionality))))}))}function q(e){let{environment:t,collectionStore:n,compoundTemplateInstancesToDelete:o}=e;const r=o.flatMap((e=>e.instancePointer.instancePointers)),i=o.map((e=>e.instancePointer.id)),c=F({environment:t,collectionStore:n}),l=[];for(const a of c)if(!i.includes(a.instancePointer.id))for(const e of a.instancePointer.instancePointers)r.some((t=>t.id===e.id))&&l.push(e);return r.filter((e=>!l.some((t=>t.id===e.id))))}},605315:(e,t,n)=>{n.d(t,{Z:()=>r});class o extends(()=>n(757695))().default{getInitialState(){return{}}append(e){const t={...this.state};for(const n of e)t[n.templateId]=n;this.setState(t)}}const r=new o},863987:(e,t,n)=>{n.d(t,{A:()=>i});class o extends(()=>n(757695))().default{getInitialState(){return null}}const r=new o;n(604341).exposeDebugValue("WorkflowTemplatesBuilderStore",r);const i=r},913454:(e,t,n)=>{n.r(t),n.d(t,{TRUNCATE_COLLECTION_TEMPLATE_ITEMS_AT:()=>W,WorkflowTemplateLogger:()=>h,getChildCollectionStoreByTemplateId:()=>C,getCollectionTemplateFromId:()=>D,getIsSetupGeneratorEnabled:()=>A,getPropertyTemplates:()=>B,getSelectedFeatureTemplateIds:()=>_,getTemplatesInCompoundTemplate:()=>R,getWorkflowTemplateItemsCaption:()=>k,getWorkflowTemplateName:()=>M,globalWorkflowTemplates:()=>S,isCollectionTemplateParentStore:()=>w,remapPropertyIds:()=>P,shouldShowInSuggestedProperties:()=>E,useCaseByCollectionTemplateCategory:()=>j});n(16280),n(944114),n(898992),n(823215),n(354520),n(672577),n(581454);var o=()=>n(663077),r=()=>n(278132),i=()=>n(992437),c=()=>n(388821),l=()=>n(696706),a=()=>n(519831),s=()=>n(96689),p=()=>n(919709),d=()=>n(496603),m=()=>n(534177),u=()=>n(519839),f=()=>n(68465),y=()=>n(972435),I=()=>n(630116),g=()=>n(204067);const v=(0,n(959013).YK)({untitled:{id:"workflowTemplates.untitled",defaultMessage:"Untitled"}});class h{log(e){0}warn(e){0}debug(e){false}}function w(e){return e instanceof I().h4||e instanceof I().SL||e instanceof I().Bv}const T=new(n(496506).default)((()=>{var e;const t=y().A.getIntl();return(0,n(104119).IC)({},t,(null===(e=n(863987).A.state)||void 0===e?void 0:e.templatesWithRowIds.map((e=>e.template)))??[],{shouldFakeLocalization:"pseudo"===t.locale,strict:!1})}),{debugName:"localizedDynamicBuilderTemplatesStore"}),S=new(o().GH)((e=>{const t=y().A.getIntl(),o=[...T.state,...(0,n(428045).Cb)(t,{localizeTemplates:!0,stage:(0,n(338907).M6)()}),...Object.values(n(605315).Z.state)].find((t=>t.templateId===e));if(!o)throw new Error(`Template not found for ${e}`);return o}));function P(e){let{collectionStore:t,dependencyMap:n,object:r}=e;(0,o().$G)({object:r,callback:e=>function(e){let{collectionStore:t,dependencyMap:n,objectWithProperty:o}=e;const r=o.property,i=(0,g().CB)({collectionStore:t,sourceTemplateType:"property",sourcePrimitiveId:r,dependencyMap:n});o.property=i}({collectionStore:t,dependencyMap:n,objectWithProperty:e})})}const b=3;function k(e){if(0===e.length)return;const t=e.slice(0,b),n=e.length-t.length,o=t.join(", ");return n>0?`${o}, ${n}+`:o}function M(e){const{type:t}=e;switch(t){case"collection_view":return e.value.name??y().A.formatMessage(u().Xg[e.value.type]);case"property":return e.value.name;case"collection":return e.value.targetCollection.name;case"layout":case"compound":return e.name;case"block":const n=c().RecordMap.create(e.value.recordMap),o=n.getModel(e.value.blockPointer);return o?(0,p().q4_)(o.getRenderTitleTextValue({getRecordModel:i().b.fromRecordMap(n)})):y().A.formatMessage(v.untitled);case"automation":return e.value.name??(0,r().PK)(y().A.getIntl());default:(0,m().HB)(t)}}function _(e){return e.featureTemplateSelections.filter((e=>e.selected)).map((e=>e.template.templateId))}function C(e){let{environment:t,parentStore:n,collectionTemplateId:o}=e;const r=n.getSpaceId();if(!r)throw new Error(`Space ID not found for ${n}`);const i=new(I().SL)(t,{table:s().NX,id:r}),c=(0,g().wW)({environment:t,spaceStore:i,templateId:o});for(const s of c){var p;const e=new(I().md)(t,{table:a().Vl,id:s.id}),o=null===(p=e.getParentBlockStore())||void 0===p?void 0:p.getParentPointer();if(o&&l().L3.isEqual(o,n.pointer))return e}}function R(e){const t=e.value.templateItems.map((e=>S.fromId(e.pointer))),n=[];for(const r of t){if(!(0,o().$K)(r))throw new Error(`Invalid template "${r.templateId}" in compound template "${e.templateId}"`);n.push(r)}return n}function B(e){const t=[];for(const n of e)"property"===n.type?t.push(n):"compound"===n.type&&t.push(...R(n).filter((e=>(0,o().Xq)(e,"property"))));return d().hS(t,(e=>e.templateId))}const W=3;function A(e){return(0,f().ZE)(e)}function E(e){return"property"===e.type||"compound"===e.type&&R(e).every((e=>"property"===e.type))}const j={goals:"goals",projects:"project",tasks:"other",docs:"docs",meetings:"notes"};function D(e){try{return S.fromIdOfType({templateId:e,type:"collection"})}catch(t){return}}}}]);