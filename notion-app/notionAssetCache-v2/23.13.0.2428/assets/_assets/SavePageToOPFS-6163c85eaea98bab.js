"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[82094],{368335:(e,n,t)=>{t.r(n),t.d(n,{SavePageToOPFS:()=>C});t(517642),t(658004),t(733853),t(845876),t(432475),t(515024),t(731698),t(898992),t(354520),t(908872);var a=t(296540),r=()=>t(395361),i=()=>t(484714),o=()=>t(452540),c=()=>t(134025),s=()=>t(179034),d=()=>t(963589);var u=()=>t(495074),l=()=>t(733539),g=()=>t(585515),k=()=>t(577449),f=()=>t(631616),v=()=>t(388821),m=()=>t(780054),p=()=>t(870618),b=()=>t(351360),h=()=>t(53429);var _=()=>t(865085);function T(e){const n=(0,i().v3)(),t=_().z.isEnabled,[T,C]=(0,a.useState)(!1),y={revisionTracking:(0,d().X)("opfs_save_page_strategy_revision_tracking"),syncTracking:(0,d().X)("opfs_save_page_strategy_sync_tracking"),backgrounded:(0,d().X)("opfs_save_page_strategy_background"),navigation:(0,d().X)("opfs_save_page_strategy_navigation")},w=(0,a.useCallback)((e=>{(async function(e,n){if(!n.currentUser.id||!b().default.state.currentSpaceStore)return;performance.mark("generate-chunk-start");const t=v().RecordMapWithRole.create();await(0,g().T)({page:{spaceId:b().default.state.currentSpaceStore.id,id:e},limit:Number.MAX_SAFE_INTEGER,cursor:{stack:[]},verticalColumns:!0,baseUrl:m().A.domainBaseUrl,publicDomainName:m().A.publicDomainName,shouldTraverseToggleBlocks:!0,loadButtonBlockChildren:!0,batchLoadChildren:!0,contentBatchSize:1e3},k().h.fromMonomorphicFunctionUnsafe((async e=>{const a=await p().h7({environment:n,pointer:e,useInMemoryCacheOnly:!0,skipAccessWrites:!0});return a?(t.setModelAndRole(e,a.model,a.role),a.model):void 0}))),performance.mark("generate-chunk-end"),performance.measure("generate-chunk","generate-chunk-start","generate-chunk-end"),await h().J.write((0,f().$)(n.currentUser.id,e),t)})(e,n).catch((e=>{}))}),[n]),E=(0,r().Y)((e=>{window.requestIdleCallback?window.requestIdleCallback((()=>w(e)),{timeout:1e4}):setTimeout((()=>w(e)),2e3)}),1e3),S=(0,a.useCallback)((function(){for(var n=arguments.length,t=new Array(n),a=0;a<n;a++)t[a]=arguments[a];for(const r of t){const n=(0,o().W8)({combinedId:r.combinedId});"track_page"===r.type&&n.id===e?C(!0):"untrack_page"===r.type&&n.id===e&&C(!1)}}),[e]);(0,a.useEffect)((()=>{if(!y.revisionTracking&&!y.syncTracking)return void u().A.removeListener(S);u().A.addListener(S);return u().A.getPageBlockTrackerForPage({table:s().ev,id:e})&&C(!0),()=>u().A.removeListener(S)}),[e,S,y.revisionTracking,y.syncTracking]);const L=(0,a.useMemo)((()=>{if(!1!==T)return u().A.getPageBlockTrackerForPage({table:s().ev,id:e})}),[e,T]),A=(0,a.useCallback)((()=>{if(!L)return;performance.mark("revisionChangeDetectionStart");const n=l().default.state,t=n.undoStack[n.undoStack.length-1];if(!t)return;const a=t.transactions.reduce(((e,n)=>{for(const t of n.operations)if(t.pointer.table===s().ev&&e.add(t.pointer.id),(0,c().mP)(t)&&t.additionalUpdatedPointers)for(const n of t.additionalUpdatedPointers)n.table===s().ev&&e.add(n.id);return e}),new Set),r=L.getLiveBlocks().filter((e=>{let{blockStore:n}=e;return a.has(n.id)}));performance.mark("revisionChangeDetectionEnd");performance.measure("revisionChangeDetection","revisionChangeDetectionStart","revisionChangeDetectionEnd");r.length>0&&E(e)}),[L,e,E]);(0,a.useEffect)((()=>{if(t&&y.revisionTracking&&L)return l().default.addListener(A),()=>l().default.removeListener(A)}),[t,y.revisionTracking,L,A]);const P=(0,a.useCallback)((()=>{E(e)}),[e,E]),B=(0,r().Y)(P,50);(0,a.useEffect)((()=>{if(t&&y.syncTracking&&L)return L.addListener(B),()=>{L.removeListener(B)}}),[t,y.syncTracking,L,B]),(0,a.useEffect)((()=>{if(y.navigation)return()=>{E(e)}}),[y.navigation,e,E]);!function(e,n){const t=(0,r().Y)(e,(null==n?void 0:n.debounceTimeMs)??256),i=(0,a.useCallback)((()=>{document.hidden&&t()}),[t]),o=(0,a.useCallback)((()=>{t()}),[t]);(0,a.useEffect)((()=>(document.addEventListener("visibilitychange",i),window.addEventListener("blur",o),()=>{document.removeEventListener("visibilitychange",i),window.removeEventListener("blur",o),t.cancel()})),[t,i,o])}((0,a.useCallback)((()=>{t&&y.backgrounded&&E(e)}),[t,y.backgrounded,e,E]))}function C(e){let{pageId:n}=e;return T(n),null}}}]);