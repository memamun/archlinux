"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[11097,16697],{173019:(e,t,o)=>{o.d(t,{r:()=>n});o(296540);var r=o(474848);const n=(0,o(340498).wt)("pencil",{viewBox:"0 0 16 16",svg:(0,r.jsx)("path",{d:"M3.926 13.307H14.11c.183 0 .34-.066.472-.199a.644.644 0 00.198-.471.652.652 0 00-.198-.479.644.644 0 00-.472-.198H5.272l-1.346 1.347zm-.704-.636l7.683-7.684-1.312-1.319-7.69 7.684-.67 1.606c-.037.1-.017.191.06.273.083.082.174.105.274.069l1.655-.63zm8.34-8.326l.738-.732c.182-.187.278-.376.287-.567.009-.192-.068-.374-.232-.547l-.267-.267c-.169-.168-.351-.246-.547-.232-.196.014-.385.11-.567.287l-.739.732 1.327 1.326z"})})},363186:(e,t,o)=>{o.d(t,{$O:()=>l,HH:()=>c,X9:()=>u,_o:()=>d});o(16280);var r=o(296540),n=()=>o(56366),a=()=>o(890754),i=()=>o(847),s=o(474848);const d=(0,r.createContext)(null);function l(){const e=(0,r.useContext)(d);if(!e)throw new Error("useWorkflowEditorContext must be used inside WorkflowEditorContextProvider");return e}function c(){return(0,r.useContext)(d)??void 0}d.displayName="WorkflowEditorContext";const u=r.memo((function(e){let{children:t,store:l}=e;const c=(0,o(484714).v3)(),u=(0,o(424141).y)(l),f=o(985554).K,w=(0,a().useChatSidebarState)(),p=(null==w?void 0:w.chatThreadId)!==a().NEW_CHAT_THREAD_ID?null==w?void 0:w.chatThreadId:void 0,v=null==w?void 0:w.workflowStepId,S=(0,n().K8)((()=>{const{currentSpaceStore:e}=o(351360).default.state;if(e&&p)return o(630116).Ei.createChildStore(e,{table:o(234459).To,id:p,spaceId:e.id})}),[p]),h=(0,r.useCallback)((async e=>{var t;const{threadId:r,stepId:n}=e;if(r===p&&n===v)return;if(S&&"update"===(null===(t=(0,o(900535).t)({threadStore:S,workflowStore:u,clientStore:f,focusedWorkflowStepId:v}))||void 0===t?void 0:t.type)){const{accept:e}=await o(901389).Gh({message:"You have unsaved changes",description:"You can return to this chat to resume editing.",acceptLabel:"Continue without saving",cancelLabel:"Cancel"});if(!e)return}(0,o(118078).openChatSidebar)({environment:c,chatThreadId:r,workflowStepId:n})}),[p,v,S,u,f,c]),m=(0,n().K8)((()=>{if(o(508496).default.checkGate({gateName:"workflows_simple_mode"})){return{type:"simple-workflow"}}return{type:"workflow",workflowBlockId:l.id}}),[l]),k=(0,r.useCallback)((e=>{if(!u)throw new Error("Cannot save trigger without a workflow store");const t=i().saveTrigger({workflowStore:u,trigger:e,environment:c,threadStore:S,clientStore:f});h({threadId:t})}),[f,c,h,S,u]),y=(0,r.useCallback)((e=>{if(!u)throw new Error("Cannot save trigger without a workflow store");const t=i().saveTriggers({workflowStore:u,triggers:e,environment:c,threadStore:S,clientStore:f});h({threadId:t})}),[f,c,h,S,u]),C=(0,r.useCallback)((e=>{if(!u)throw new Error("Cannot save module without a workflow store");const t=i().saveModule({workflowStore:u,module:e,environment:c,threadStore:S,clientStore:f});h({threadId:t})}),[f,c,h,S,u]),g=(0,r.useCallback)((e=>{if(!u)throw new Error("Cannot add module without a workflow store");const t=i().addModule({workflowStore:u,module:e,environment:c,threadStore:S,clientStore:f});h({threadId:t})}),[f,c,h,S,u]),_=(0,r.useCallback)((e=>{const{functionStore:t,fn:o}=e;if(!u)throw new Error("Cannot save function without a workflow store");const r=i().saveFunction({functionStore:t,fn:o,environment:c,threadStore:S,clientStore:f,workflowStore:u});h({threadId:r})}),[f,c,h,S,u]),b=(0,r.useCallback)((e=>{const{functionStore:t,test:o}=e;if(!u)throw new Error("Cannot save test without a workflow store");const r=i().saveTest({functionStore:t,environment:c,test:o,threadStore:S,clientStore:f,workflowStore:u});h({threadId:r})}),[f,c,h,S,u]),T=(0,r.useMemo)((()=>({store:l,workflowStore:u,threadStore:S,clientStore:f,saveTrigger:k,saveTriggers:y,saveModule:C,addModule:g,saveFunction:_,saveTest:b,config:m,onThreadChange:h})),[f,m,k,y,C,g,_,b,l,S,u,h]);return(0,s.jsx)(d.Provider,{value:T,children:t})}))},390527:(e,t,o)=>{o.r(t),o.d(t,{DEFAULT_MAX_RECURRENCE_DUPLICATION_PER_TASK:()=>P,MAXIMUM_DAILY_RECURRENCES_IN_PATH:()=>_,MAXIMUM_NESTED_RECURRENCE_LEVEL:()=>g,MAX_RECURRENCE_INTERVAL:()=>h,MAX_RECURRENCE_NUMBER_OF_RUNS:()=>m,RRULE_WEEKDAYS_MAP:()=>S,adjustedStartDateIfPossible:()=>T,areRecurrenceSchedulesEqual:()=>J,convertFromUnpersistedRecurrenceConfig:()=>x,convertToUnpersistedRecurrenceConfig:()=>W,getFormattedEndCondition:()=>R,getFormattedNextRecurrenceTime:()=>I,getNewEndTimestamp:()=>D,getNextDateUtc:()=>M,getRecurrenceAfter:()=>A,isRunningBetweenMidnightAnd3AM:()=>E,isValidRecurrenceInterval:()=>k,isValidRecurrenceNumberOfRuns:()=>y,rruleFromRecurrence:()=>C,templateAncestorsViolateRecurrenceNesting:()=>b});o(898992),o(354520),o(581454);var r=()=>o(244641);o(944114);function n(e){for(var t=arguments.length,o=new Array(t>1?t-1:0),r=1;r<t;r++)o[r-1]=arguments[r];if(0===o.length)return e.map((e=>[e]));const a=[];for(const i of e)a.push(...n(o[0],...o.slice(1)).map((e=>[i,...e])));return a}var a=()=>o(496603),i=()=>o(534177),s=()=>o(720665),d=()=>o(597777),l=()=>o(869190),c=()=>o(416504),u=()=>o(402390);class f extends(()=>o(896346))().p3{constructor(e,t){super(e,t)}after(e,t){return super.after(e,t)}}var w=()=>o(912720);const p=(0,o(959013).YK)({dateAtTime:{id:"automations.recurrenceHelpers.dateAtTime",defaultMessage:"{date} at {time}"},dateBetweenMidnightAnd3AM:{id:"automations.recurrenceHelpers.dateBetweenMidnightAnd3AM",defaultMessage:"{date} between 12â€“3 AM"},numberEndConditionDescription:{id:"automations.recurrenceHelpers.numberEndConditionDescription",defaultMessage:"{number, plural, one {After {number} run} other {After {number} runs}}"},noEndCondition:{id:"automations.recurrenceHelpers.noEndCondition",defaultMessage:"Never"}}),v={day:f.DAILY,week:f.WEEKLY,month:f.MONTHLY,year:f.YEARLY},S={MO:f.MO,TU:f.TU,WE:f.WE,TH:f.TH,FR:f.FR,SA:f.SA,SU:f.SU},h=99,m=999;function k(e){return(0,s().Et)(e)&&Number.isInteger(e)&&e>0&&e<=h}function y(e){return(0,s().Et)(e)&&Number.isInteger(e)&&e>0&&e<=m}function C(e){const{start_date:t,frequency:o,interval:r,weekdays:a,timezone:s,hour:l,minute:c}=e,u="week"===o&&a?a.map((e=>S[e])):void 0,w={};return(0,i().O9)(e.end_condition)&&("date"===e.end_condition.type?w.until=(0,d().eU)(e.end_condition.end_at):"number"===e.end_condition.type?w.count=e.end_condition.number_of_occurrences:(0,i().HB)(e.end_condition)),"month"===e.frequency&&(0,i().O9)(e.monthly_restriction)&&("monthdays"===e.monthly_restriction.type?w.bymonthday=e.monthly_restriction.monthdays:"weekdays_in_month"===e.monthly_restriction.type?w.byweekday=n(e.monthly_restriction.weekdays,e.monthly_restriction.week_numbers).map((e=>{let[t,o]=e;return S[t].nth(o)})):(0,i().HB)(e.monthly_restriction)),new f({freq:v[o],dtstart:(0,d().eU)(t),interval:r,byweekday:u,tzid:s,byhour:l??0,byminute:c??0,bysecond:0,...w})}const g=1,_=1;function b(e){var t;if(0===e.length)return{violatesConstraint:!1,templateNestingExceedsMaxDepth:!1,ancestorHasDailyTemplate:!1,nestedDepthOfAutomationAncestors:void 0,immediateAncestorRecurrenceType:void 0};const o=e.filter((e=>{var t;return"day"===(null===(t=e.getRecurrence())||void 0===t?void 0:t.frequency)})),r=e.length,n=null===(t=e[0].getRecurrence())||void 0===t?void 0:t.frequency,a=r>g,i=o.length>=_;return{violatesConstraint:a||i,templateNestingExceedsMaxDepth:a,ancestorHasDailyTemplate:i,nestedDepthOfAutomationAncestors:r,immediateAncestorRecurrenceType:n}}function T(e){var t;const{recurrence:o,afterDate:n}=e;if("number"===(null===(t=o.end_condition)||void 0===t?void 0:t.type)||o.start_date>=n)return o;let a=r().c9.fromMillis(o.start_date,{zone:"utc"});const i=r().c9.fromMillis(n,{zone:"utc"});switch(o.frequency){case"year":{const e=Math.floor(i.diff(a,"years").years/o.interval);a=a.plus({years:e*o.interval});break}case"month":{const e=Math.floor(i.diff(a,"months").months/o.interval);a=a.plus({months:e*o.interval});break}case"week":{const e=Math.floor(i.diff(a,"weeks").weeks/o.interval);a=a.plus({weeks:e*o.interval});break}case"day":{const e=Math.floor(i.diff(a,"days").days/o.interval);a=a.plus({days:e*o.interval});break}}return{...o,start_date:(0,d().DH)(a.toMillis())}}function A(e){const{recurrence:t,afterDate:o}=e;if((0,w().wt)(t)){const e=(0,d().l1)(o);return t.start_date>=e?new Date(t.start_date):void 0}{const e=C(T({recurrence:t,afterDate:o})).after((0,d().eU)(o));if(!e)return;return(0,d().h1)(e)}}function E(e){return 0===e.hour||1===e.hour||2===e.hour}function M(e){return C(e).after((0,d().eU)((0,d().Rz)()))||void 0}function I(e){const{recurrence:t,intl:o}=e,n=M(x(t));if(!n)return;const a=E(t),i=r().c9.fromJSDate(n).toUTC().setZone("local",{keepLocalTime:!0}).setLocale((0,u().H)(o)).setZone(t.timezone),s=(0,l().Yq)({date:i,dateFormat:"relative",allowRelativeDates:!0,intl:o,shortenDate:!0});if(a)return o.formatMessage(p.dateBetweenMidnightAnd3AM,{date:s});{let e=i.toLocaleString(r().c9.TIME_SIMPLE);return t.timezone!==(0,c().P)()&&(e+=` ${i.toFormat("ZZZZ")}`),o.formatMessage(p.dateAtTime,{date:s,time:e})}}function R(e,t){return(0,i().O9)(e)?"number"===e.type?t.formatMessage(p.numberEndConditionDescription,{number:e.number_of_occurrences}):"date"===e.type?(0,l().Yq)({date:r().c9.fromMillis(e.end_at),dateFormat:"relative",allowRelativeDates:!0,intl:t,shortenDate:!0}):void(0,i().HB)(e):t.formatMessage(p.noEndCondition)}const P=100;function W(e){return{...e,start_date:(0,d().l1)(e.start_date),end_condition:e.end_condition?"number"===e.end_condition.type?e.end_condition:"date"===e.end_condition.type?{type:"date",end_at:(0,d().l1)(e.end_condition.end_at)}:(0,i().HB)(e.end_condition):void 0}}function D(e,t,o){return e.plus(o-t)}function U(e,t){const o=r().c9.fromMillis(t.end_at).set({hour:e.hour??0,minute:e.minute??0});return{type:"date",end_at:(0,d().Rz)(o.toJSDate())}}function x(e){return{...e,start_date:(0,d().Rz)(new Date(e.start_date)),end_condition:e.end_condition?"number"===e.end_condition.type?e.end_condition:"date"===e.end_condition.type?U(e,e.end_condition):(0,i().HB)(e.end_condition):void 0}}function J(e,t){const o=a().fN(e,(e=>void 0!==e)),r=a().fN(t,(e=>void 0!==e));return a().n4(o,r)}},424141:(e,t,o)=>{o.d(t,{y:()=>i});var r=()=>o(56366),n=()=>o(743246),a=()=>o(630116);function i(e){return(0,r().K8)((()=>{var t;if(!e)return;const o=null===(t=e.getFormat())||void 0===t?void 0:t.workflow_id;return o?a().NU.createChildStore(e,{table:n().C0,id:o,spaceId:e.getSpaceId()}):void 0}),[e])}},555555:(e,t,o)=>{o.d(t,{n:()=>n});o(296540);var r=o(474848);const n=(0,o(340498).wt)("import",{viewBox:"0 0 16 16",svg:(0,r.jsx)("path",{d:"M13.291 14.5723C13.291 14.1484 12.9902 13.834 12.5732 13.834H8.06836C8.24609 13.8203 8.42383 13.7314 8.56055 13.5947L13.0586 9.08301C13.2158 8.91895 13.291 8.74121 13.291 8.54297C13.291 8.12598 12.9902 7.81836 12.5801 7.81836C12.3682 7.81836 12.1836 7.90039 12.0469 8.03711L10.4951 9.56836L8.69043 11.585L8.75195 10.1084V1.61133C8.75195 1.16016 8.44434 0.852539 8 0.852539C7.5625 0.852539 7.25488 1.16016 7.25488 1.61133V10.1084L7.30957 11.5781L5.50488 9.56836L3.95312 8.03711C3.82324 7.90039 3.63184 7.81836 3.42676 7.81836C3.0166 7.81836 2.70898 8.12598 2.70898 8.54297C2.70898 8.74121 2.78418 8.91895 2.94141 9.08301L7.44629 13.5947C7.58301 13.7314 7.75391 13.8203 7.93848 13.834H3.44043C3.0166 13.834 2.70898 14.1484 2.70898 14.5723C2.70898 14.9893 3.0166 15.3037 3.44043 15.3037H12.5732C12.9902 15.3037 13.291 14.9893 13.291 14.5723Z"})})},556048:(e,t,o)=>{o.d(t,{C8:()=>f,Dz:()=>d,GC:()=>p,GL:()=>v,YY:()=>w,dM:()=>c,h9:()=>l,jX:()=>s,oF:()=>u,uj:()=>i});var r=()=>o(645873);const n={JiraSyncInfoPopup:new(r().O2)("JiraSyncInfoPopup",(async()=>await Promise.all([o.e(75134),o.e(68744)]).then(o.bind(o,408453)))),ImproveJiraSyncPopup:new(r().O2)("ImproveJiraSyncPopup",(async()=>await Promise.all([o.e(75134),o.e(2686)]).then(o.bind(o,484967)))),JiraDCAuthModal:new(r().O2)("JiraDCAuthModal",(async()=>await o.e(28763).then(o.bind(o,992567)))),ExternalImportAndSyncIndicator:new(r().O2)("ExternalImportAndSyncIndicator",(async()=>await o.e(98288).then(o.bind(o,984289)))),JiraSyncedAllProjectsTooltip:new(r().O2)("JiraSyncedAllProjectsTooltip",(async()=>await Promise.all([o.e(23806),o.e(21446)]).then(o.bind(o,470020)))),JiraSyncedAllIssuesTooltip:new(r().O2)("JiraSyncedAllIssuesTooltip",(async()=>await Promise.all([o.e(23806),o.e(21446)]).then(o.bind(o,470020)))),JiraSyncedDatabaseViewsAndFiltersTooltip:new(r().O2)("JiraSyncedDatabaseViewsAndFiltersTooltip",(async()=>await Promise.all([o.e(23806),o.e(21446)]).then(o.bind(o,470020)))),JiraSyncSourceTooltip:new(r().O2)("JiraSyncSourceTooltip",(async()=>await Promise.all([o.e(23806),o.e(21446)]).then(o.bind(o,470020)))),JiraSyncedSettingsToSetupProjectsAndIssuesTooltip:new(r().O2)("JiraSyncedSettingsToSetupProjectsAndIssuesTooltip",(async()=>await Promise.all([o.e(23806),o.e(21446)]).then(o.bind(o,470020))))},a={JiraSyncTeamSpaceModal:new(r().O2)("JiraSyncTeamSpaceModal",(async()=>Promise.all([o.e(23806),o.e(56188)]).then(o.bind(o,604698))))},i=(0,r()._h)(a.JiraSyncTeamSpaceModal,(e=>e.default)),s=(0,r()._h)(n.JiraSyncedAllProjectsTooltip,(e=>e.JiraSyncedAllProjectsTooltip)),d=(0,r()._h)(n.JiraDCAuthModal,(e=>e.default)),l=(0,r()._h)(n.JiraSyncedAllIssuesTooltip,(e=>e.JiraSyncedAllIssuesTooltip)),c=(0,r()._h)(n.JiraSyncedDatabaseViewsAndFiltersTooltip,(e=>e.JiraSyncedDatabaseViewsAndFiltersTooltip)),u=(0,r()._h)(n.JiraSyncedSettingsToSetupProjectsAndIssuesTooltip,(e=>e.JiraSyncedSettingsToSetupProjectsAndIssuesTooltip)),f=(0,r()._h)(n.JiraSyncSourceTooltip,(e=>e.JiraSyncSourceTooltip)),w=(0,r()._h)(n.JiraSyncInfoPopup,(e=>e.JiraSyncInfoPopup)),p=(0,r()._h)(n.ImproveJiraSyncPopup,(e=>e.ImproveJiraSyncPopup)),v=(0,r()._h)(n.ExternalImportAndSyncIndicator,(e=>e.ExternalImportAndSyncIndicator));(0,o(340498).xh)("jira",{default:{loader:()=>o.e(60677).then(o.bind(o,460677)),size:20},small:{loader:()=>o.e(60677).then(o.bind(o,460677)),size:16},mini:{loader:()=>o.e(60677).then(o.bind(o,460677)),size:14},large:{loader:()=>o.e(60677).then(o.bind(o,460677)),size:24}})},776690:(e,t,o)=>{o.d(t,{J:()=>l});var r=()=>o(484714),n=()=>o(56366),a=o(296540),i=()=>o(496603);var s=()=>o(363186),d=()=>o(94522);function l(){const{workflowStore:e,threadStore:t,clientStore:o}=(0,s().$O)(),l=(0,r().v3)();return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i().n4;const o=(0,a.useRef)(e);return t(o.current,e)||(o.current=e),o.current}((0,n().K8)((()=>(0,d().n2)({workflowStore:e,threadStore:t,clientStore:o,environment:l})),[e,t,o,l]))}},835755:(e,t,o)=>{o.d(t,{p:()=>n});o(296540);var r=o(474848);const n=(0,o(340498).wt)("collectionDescriptionSmall",{viewBox:"0 0 14 14",svg:(0,r.jsx)("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7 4.667C6.69049 4.667 6.39366 4.54405 6.17481 4.32519C5.95595 4.10634 5.833 3.80951 5.833 3.5C5.833 3.19049 5.95595 2.89366 6.17481 2.67481C6.39366 2.45595 6.69049 2.333 7 2.333C7.30951 2.333 7.60634 2.45595 7.82519 2.67481C8.04405 2.89366 8.167 3.19049 8.167 3.5C8.167 3.80951 8.04405 4.10634 7.82519 4.32519C7.60634 4.54405 7.30951 4.667 7 4.667V4.667ZM8 11C8 11.2652 7.89464 11.5196 7.70711 11.7071C7.51957 11.8946 7.26522 12 7 12C6.73478 12 6.48043 11.8946 6.29289 11.7071C6.10536 11.5196 6 11.2652 6 11V7C6 6.73478 6.10536 6.48043 6.29289 6.29289C6.48043 6.10536 6.73478 6 7 6C7.26522 6 7.51957 6.10536 7.70711 6.29289C7.89464 6.48043 8 6.73478 8 7V11ZM7 0C5.14348 0 3.36301 0.737498 2.05025 2.05025C0.737498 3.36301 0 5.14348 0 7C0 8.85652 0.737498 10.637 2.05025 11.9497C3.36301 13.2625 5.14348 14 7 14C8.85652 14 10.637 13.2625 11.9497 11.9497C13.2625 10.637 14 8.85652 14 7C14 5.14348 13.2625 3.36301 11.9497 2.05025C10.637 0.737498 8.85652 0 7 0V0Z"})})},887811:(e,t,o)=>{o.r(t),o.d(t,{WorkflowEditorCollectionViewPage:()=>m});var r=o(296540),n=()=>o(56366),a=()=>o(372915),i=()=>o(106412),s=()=>o(221844),d=()=>o(484714),l=()=>o(179034),c=()=>o(743246),u=()=>o(896628),f=()=>o(246826),w=()=>o(317909),p=()=>o(847),v=()=>o(776690);var S=()=>o(363186),h=o(474848);function m(e){const{store:t}=e;return(0,h.jsx)(S().X9,{store:t,children:(0,h.jsx)(k,{...e})})}function k(e){const{store:t}=e,o=function(e){const{collectionViewBlockStore:t}=e,o=(0,d().v3)(),a=(0,v().J)(),i=(0,n().K8)((()=>t.getSpaceId()),[t]),[S,h]=(0,r.useState)([]),m=(0,r.useCallback)((e=>{h((t=>[...t,e.operation]))}),[]);(0,r.useEffect)((()=>{}),[S]);const k=(0,r.useMemo)((()=>{const e=new(s().A)({isTemporaryData:!0,name:"workflowDataCache"});return e.addCacheFallback(o.defaultRecordCache.inMemoryRecordCache),e}),[o.defaultRecordCache.inMemoryRecordCache]),y=(0,r.useMemo)((()=>{const e=new(s().A)({isTemporaryData:!0,name:"userEditsCache"});return e.addCacheFallback(k),e.onOperationCallback=m,e}),[m,k]),C=(0,r.useMemo)((()=>t.clone(k)),[t,k]),g=(0,r.useMemo)((()=>C.clone(y)),[C,y]);return(0,r.useEffect)((()=>{k.clearCache(),y.clearCache(),h([]),a&&w().createAndCommit({userAction:"workflowData",environment:o,perform:e=>{const t=f().eC({environment:o,table:c().C0,value:{data:a,parent_table:l().ev,parent_id:C.id,space_id:i},inMemoryRecordCache:k,transaction:e});u().zA({stores:[C],update:{workflow_id:t.id},transaction:e}),p().updateDatabasesAndViews({environment:o,store:C,workflowStore:t,previousWorkflow:void 0,newWorkflow:a,transaction:e,performPushToDatabases:!0})},canUndo:!1})}),[o,i,y,a,k,C]),g}({collectionViewBlockStore:t}),S=(0,n().K8)((()=>{var e;return null===(e=o.inMemoryRecordCache)||void 0===e?void 0:e.name}),[o]);return(0,h.jsx)(i().tx,{value:{isPreviewing:!0,disablePageLinks:!0,disableAllPointerEvents:!1,hideTableAggregationRow:!1,hideViewBlockSource:!1,location:"app_builder"},children:(0,r.createElement)(a().A,{...e,key:S,store:o})})}},900535:(e,t,o)=>{o.d(t,{t:()=>c});o(16280),o(813451),o(898992),o(354520);var r=()=>o(724639),n=()=>o(496603),a=()=>o(255299),i=()=>o(630116),s=()=>o(94522);function d(e){const{transcript:t,saved:o,toIndex:n}=e,a=n?t.slice(0,n):t,i=a.findLastIndex((e=>"workflow"===e.type&&(void 0===o||e.saved===o)));if(-1===i)return;const s=a[i];if("workflow"!==s.type)return;const d=(0,r().Uj)({workflowStepIndex:i,transcript:t});return{step:s,index:i,mergedWorkflow:(0,r().Kq)({workflowValue:s.value,operationSteps:d}),operationSteps:d}}function l(e){var t,o;const{threadStore:r,versionPointer:n,savedVersionPointer:a}=e,s=i().je.createChildStore(r,n);if(!s.isVersion())return;const d=null===(t=s.getData())||void 0===t?void 0:t.version;if(!d)return;const l=i().je.createChildStore(r,a);if(!l.isVersion())return;const c=null===(o=l.getData())||void 0===o?void 0:o.version;return c?c===d?"equal":d<c?"restore":"update":void 0}function c(e){var t;const{threadStore:o,workflowStore:i,clientStore:c,focusedWorkflowStepId:f}=e;if(c.state.loading)return;const w=(0,a().A3)({clientStore:c,threadStore:o});if(f){var p;const e=w.findIndex((e=>e.id===f));if(-1===e)return;const t=w[e];if("workflow"!==t.type)throw new Error("Focused build step is not a workflow");if(null===(p=t.value)||void 0===p||!p.versionPointer)return;const a=(0,r().Uj)({workflowStepIndex:e,transcript:w}),c=(0,r().Kq)({workflowValue:t.value,operationSteps:a}),v=u(w.slice(e+1));if(!i)return{type:"create",workflowStepToSave:t,newWorkflow:c,threadStore:o,numUnsavedWorkflowOperationSteps:a.length,numUnsavedWorkflowSteps:v};const S=d({transcript:w,saved:!0,toIndex:e});if(!S)return;const h=(0,s().dh)(i);if(!h.versionPointer)return n().n4(h,c)?void 0:{type:"update",baseWorkflow:h,workflowStepToSave:t,newWorkflow:c,threadStore:o,workflowStore:i,numUnsavedWorkflowOperationSteps:a.length,numUnsavedWorkflowSteps:v};const m=l({threadStore:o,versionPointer:t.value.versionPointer,savedVersionPointer:h.versionPointer});if("equal"===m)return;return"restore"===m?{type:"restore",workflowStepToSave:t,newWorkflow:c,threadStore:o,workflowStore:i,numUnsavedWorkflowOperationSteps:a.length,numUnsavedWorkflowSteps:v}:{type:"update",baseWorkflow:S.mergedWorkflow,workflowStepToSave:t,newWorkflow:c,threadStore:o,workflowStore:i,numUnsavedWorkflowOperationSteps:a.length,numUnsavedWorkflowSteps:v}}const v=w.findLastIndex((e=>"workflow"===e.type&&e.saved)),S=u(w.slice(v+1)),h=d({transcript:w});if(null==h||null===(t=h.mergedWorkflow)||void 0===t||!t.versionPointer)return;if(!i)return{type:"create",workflowStepToSave:h.step,newWorkflow:h.mergedWorkflow,threadStore:o,numUnsavedWorkflowOperationSteps:h.operationSteps.length,numUnsavedWorkflowSteps:S};const m=d({transcript:w,saved:!0,toIndex:h.index});if(!m)return;const k=(0,s().dh)(i);if(!k.versionPointer)return n().n4(k,h.mergedWorkflow)?void 0:{type:"update",baseWorkflow:k,workflowStepToSave:h.step,newWorkflow:h.mergedWorkflow,threadStore:o,workflowStore:i,numUnsavedWorkflowOperationSteps:h.operationSteps.length,numUnsavedWorkflowSteps:S};const y=l({threadStore:o,versionPointer:h.mergedWorkflow.versionPointer,savedVersionPointer:k.versionPointer});return"equal"!==y?"restore"===y?{type:"restore",workflowStepToSave:h.step,newWorkflow:h.mergedWorkflow,threadStore:o,workflowStore:i,numUnsavedWorkflowOperationSteps:h.operationSteps.length,numUnsavedWorkflowSteps:S}:{type:"update",baseWorkflow:m.mergedWorkflow,workflowStepToSave:h.step,newWorkflow:h.mergedWorkflow,threadStore:o,workflowStore:i,numUnsavedWorkflowOperationSteps:h.operationSteps.length,numUnsavedWorkflowSteps:S}:void 0}function u(e){return e.filter((e=>"workflow"===e.type&&"user-edit"!==e.tag)).length}}}]);