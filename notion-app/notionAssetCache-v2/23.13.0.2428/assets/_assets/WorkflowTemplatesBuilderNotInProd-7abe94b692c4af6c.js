"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[38978,71204,94611],{29037:(e,t,o)=>{o.r(t),o.d(t,{checkmarkIcon:()=>l,iconDefinition:()=>n});o(296540);const n={viewBox:"0 0 20 20",svg:(0,o(474848).jsx)("path",{d:"M15.784 4.002a.625.625 0 0 1 .214.857L9.443 15.784a.625.625 0 0 1-1.01.085l-4.37-5.098a.625.625 0 0 1 .949-.814l3.806 4.44 6.109-10.181a.625.625 0 0 1 .857-.214"})},l=(0,o(340498).wt)("checkmark",n)},175213:(e,t,o)=>{o.d(t,{G:()=>r});var n=()=>o(989423),l=()=>o(508496);function r(e,t){n().vd(e,"delete_property",t),l().default.logEvent("delete_property")}},213183:(e,t,o)=>{o.r(t),o.d(t,{WorkflowTemplatesBuilderNotInProd:()=>oo});var n=o(296540),l=()=>o(963589),r=(o(16280),o(581454),o(814603),o(147566),o(198721),()=>o(484714)),i=()=>o(56366),a=()=>o(401497),s=()=>o(498212),p=()=>o(864943),c=()=>o(339600),d=()=>o(780054),u=()=>o(264760);function m(e,t,o){!function(e,t){const o=(0,n.useRef)(),l=(0,n.useRef)();(0,n.useEffect)((()=>{if(o.current&&l.current!==t)throw new Error(`Assertion failure: "${e}" has changed. Original value was "${l.current}", but it is now "${t}".`);o.current=!0,l.current=t}),[e,t])}("persisted reducer key",e);const l=(0,n.useReducer)(t,void 0,(()=>{try{const t=window.sessionStorage.getItem(e);return t?JSON.parse(t):o}catch(t){return o}})),[r]=l;return(0,n.useEffect)((()=>{try{window.sessionStorage.setItem(e,JSON.stringify(r))}catch(t){}}),[e,r]),l}var f=()=>o(591779),y=()=>o(187174),h=()=>o(921997),g=()=>o(425981),v=(o(944114),()=>o(416504)),I=()=>o(388821),b=()=>o(919709),w=()=>o(449506),x=()=>o(44729),T=()=>o(246826),j=()=>o(606952),k=()=>o(630116),C=()=>o(861017);Error;function S(e){const{environment:t,transaction:o,rows:n,collectionInfo:{collectionId:l,spaceId:r,schema:i}}=e;let a=0,s=0;const p=function(e){const t=new Map;for(const[o,n]of Object.entries(e))n&&t.set(n.name,o);return t}(i),c=new(k().md)(t,{table:"collection",id:l,spaceId:r});for(const d of n){const{_id:e,...n}=d.value;let l;d.isNewRow?(l=T().Wv({environment:t,type:"page",inMemoryRecordCache:t.defaultRecordCache.inMemoryRecordCache,transaction:o,spaceId:r}),x().X$({childStore:l,parentStore:c,transaction:o}),a+=1):(l=k().Bv.createChildStore(c,{table:"block",id:e,spaceId:r}),s+=1);for(const[r,a]of Object.entries(n)){const e=p.get(r);if(!e)throw new Error(`Unable to find property id for "${r}"`);const n=i[e];if(!n)throw new Error(`No property schema found for "${r}"`);const s=O({value:a,schema:n}),c="title"===e?l.getBlockTitleStore():l.getPropertiesStore().getKeyStore(e);j().KY({environment:t,store:c,transaction:o,value:s})}}return{created:a,updated:s}}function O(e){const{value:t}=e;if("string"!=typeof t&&void 0!==t)throw new Error("Only property strings are currently supported.");return(0,b().x9d)(t)}function M(e){throw new Error("usePrototypeCollectionRows should never be used in production")}var _=()=>o(206267),B=()=>o(317909),V=()=>o(863987);function $(e){const{environment:t,templates:o,collectionInfo:n,templateToRowIdMap:l}=e,r=function(e,t){const o=[];for(const n of e){const e=!t.has(n.templateId),l=t.get(n.templateId)??(0,_().JW)();o.push({isNewRow:e,value:{_id:l,Name:n.templateId,JSON:JSON.stringify(n,null,2)}})}return o}(o,l);return B().createAndCommit({userAction:"prototypeBuilderRegistryActions.upsertWorkflowTemplatesToPrototypeBuilderRegistry",environment:t,canUndo:!0,perform:e=>S({environment:t,collectionInfo:n,transaction:e,rows:r})})}function N(e){let{rows:t}=e;const o=function(e){const{collectionInfo:t,errors:o}=e,n=[];for(const r of e.rows)if(r.JSON)try{const e=JSON.parse(r.JSON);n.push({collectionRowId:r._id,template:e})}catch(l){if(!(l instanceof Error))throw l;o.push({id:r._id,error:l})}return{collectionInfo:t,errors:o,templatesWithRowIds:n,templateToRowIdMap:R(n)}}(t);o.errors.length>0&&console.warn("Errors loading prototype workflow template builder registry:",o.errors),V().A.setState(o)}function R(e){const t=new Map;for(const o of e){const e=o.template.templateId,n=o.collectionRowId;t.has(e)&&console.warn(`Duplicate definition for template id "${e}" found.`,o.template),t.set(e,n)}return t}var A=()=>o(638681);A().object({required:{_id:A().string()},optional:{Name:A().string(),JSON:A().string()}});var D=()=>o(508496);function F(){return(0,i().K8)((()=>P?P.getState():D().default.getConfigKey("workflow_templates_builder_config","prototype_registry_view_url")),[])}const P=void 0;(0,o(604341).exposeDebugValue)("WorkflowTemplatesBuilderLocalRegistryViewUrlStore",P);var E=o(474848);function L(){const e=F();return e?(0,E.jsx)(W,{viewUrl:e}):null}function W(e){const{viewUrl:t}=e,o=M();return(0,n.useEffect)((()=>{o.value&&N({rows:o.value})}),[o]),null}function K(e,t){var o;switch(t.type){case"reset":return U;case"setUrl":return{...U,url:t.url};case"setMultiCollectionPageUrl":return{...U,multiCollectionPageUrl:t.url};case"setCreateCopy":return{...e,createCopy:t.createCopy};case"addNewCompoundTemplate":return{...e,newCompoundTemplates:[...e.newCompoundTemplates??[],{id:(0,s().Ay)(),initialName:t.initialName}]};case"setFeatureOrdering":return{...e,featureOrdering:t.featureOrdering};case"updateBuilderSettings":return{...e,builderSettings:{...e.builderSettings,[t.key]:{...null===(o=e.builderSettings)||void 0===o?void 0:o[t.key],[t.property]:t.value}}}}}const U={url:"",multiCollectionPageUrl:"",createCopy:!1};o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520),o(803949);var q=()=>o(663077),J=()=>o(696706),z=()=>o(959013),H=()=>o(534177),G=()=>o(720665),X=()=>o(974233),Y=()=>o(191458),Q=()=>o(913454),Z=()=>o(204067),ee=()=>o(247211);var te=()=>o(134539),oe=()=>o(888325),ne=()=>o(912720),le=()=>o(972435);const re=3;o(823215);var ie=()=>o(617871),ae=()=>o(179034),se=()=>o(71584);function pe(e){const{spaceId:t,collectionInfo:o,collectionStore:l,instanceMap:a}=e,s=(0,r().v3)(),p=(0,i().K8)((()=>{if(t&&null!=o&&o.pageTemplateIds&&l)return o.pageTemplateIds.map((e=>k().Bv.createChildStore(l,{table:ae().ev,id:e})))}),[null==o?void 0:o.pageTemplateIds,l,t]),c=(0,i().K8)((()=>!!p&&p.every((e=>ce(e)))),[p]),d=(0,i().K8)((()=>{if(!(t&&p&&o&&a&&c))return;return p.map((e=>{const t=se().loadLocalSubtree(s,{blockId:e.id,inMemoryRecordCache:e.inMemoryRecordCache,allowCopyCollections:!0,requireFullSubtree:!0,skipTransclusionContainerChildren:!1,allowCopyExternalObjectInstances:!0,includeLegacyTransclusionBlockValues:!1,excludeCrdtData:!0}),n=(0,b().q4_)(e.getTitleValue());if("error"===t.type)return{type:"error",error:`For page template "${n}", loadLocalSubtree returned "${t.reason}" for ${t.pointer.table} ${t.pointer.id}.`};const{recordMap:l}=t;for(const o of l.getModelsByTable(ae().ev))if(o.isExternalObjectInstanceType()){const e=o.getFormat();if(!e.is_placeholder)return{type:"error",error:`For page template "${n}", external object instance ${o.id} is not a placeholder.`};if(!(0,ie().CX)({integrationId:e.integration_id}))return{type:"error",error:`For page template "${n}", external object instance ${o.id} is not a Notion-owned integration.`}}for(const{model:o}of t.recordMap)null==o||o.__IM_SORRY__getValue();const r=(0,te().cV)({collectionInfo:o,pageStore:e,recordMap:l,instanceMap:a});return r?{type:"success",blockInfo:r}:{type:"error",error:`For page template "${n}", getBlockInfo returned undefined.`}}))}),[t,p,o,a,c,s]);return(0,n.useMemo)((()=>{if(!d)return{infos:void 0,errors:[]};const e=[],t=[];for(const o of d)"success"===o.type?e.push(o.blockInfo):t.push(o.error);return t.length>0?{infos:void 0,errors:t}:{infos:e,errors:t}}),[d])}function ce(e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!e.isReady())return!1;if(t[e.id])return!0;t[e.id]=!0;const o=[];if(e instanceof k().Bv){o.push(...e.getContentStores()),o.push(...e.getNonContentChildrenStores()),o.push(...e.getCollectionViewStores());const t=e.getCollectionStore();t&&o.push(t);const n=e.getTransclusionReferenceTargetStore();n&&o.push(n)}else e instanceof k().pS||e instanceof k().md||(0,H().HB)(e);return o.every((e=>ce(e,!1,t)))}const de=(0,n.createContext)(null);function ue(){const e=(0,n.useContext)(de);if(!e)throw new Error("Persisted context not found");return e}function me(e){var t,o,l,a,s;let p,c;const{state:u,dispatch:m,allIcons:b,requireTemplateInstance:x,templateRegistryMap:T,templateProvider:j}=e,S=(0,r().v3)(),O=function(e){const t=(0,C().parseRoute)({url:e,isMobile:!1,baseUrl:d().A.domainBaseUrl,publicDomainName:d().A.publicDomainName,protocol:d().A.protocol,currentUrl:void 0});if("page"===t.name&&t.blockId)return{blockId:t.blockId}}((null==u?void 0:u.url)??""),M=null==O?void 0:O.blockId;O||(p??="Invalid collection URL");const _=(0,i().K8)((()=>M?function(e){const{environment:t,collectionViewBlockId:o}=e,n=new(k().Bv)(t,{table:"block",id:o});if(!n.isReady())return{type:"loading"};if(!n.getModel())return{type:"error",message:"Inaccessible collection view block"};if(!n.isCollectionView())return{type:"error",message:"Block is not a collection view block/page"};const l=n.getCollectionStore();return null!=l&&l.isReady()?l.getModel()?{type:"success",collectionViewBlockStore:n,collectionStore:l,spaceId:l.getSpaceId()}:{type:"error",message:"Inaccessible collection"}:{type:"loading"}}({collectionViewBlockId:M,environment:S}):{type:"loading"}),[M,S]);let B;switch(_.type){case"error":p??=_.message;break;case"loading":c??="Loading collection";break;case"success":B=_;break;default:(0,H().HB)(_)}const V=null===(t=B)||void 0===t?void 0:t.spaceId,$=null===(o=B)||void 0===o?void 0:o.collectionStore.id,N=null===(l=B)||void 0===l?void 0:l.collectionStore,R=(0,i().K8)((()=>{if(!N)return;const e=(0,Y().loadWorkflowTemplateInstances)(N);return e.isLoading?{status:"pending"}:{status:"resolved",value:{[`collection:${N.id}`]:(0,Z().b3)(e.instances)}}}),[N]),A=(0,n.useMemo)((()=>{if(null!=R&&R.value)return function(e,t){const o={};for(const n of(0,G().HP)(e)){const l=e[n];o[n]=(0,Z().ju)(l,t)}return o}(R.value,j)}),[null==R?void 0:R.value,j]),D=null===(a=B)||void 0===a?void 0:a.collectionViewBlockStore;let F=(0,i().K8)((()=>{if(D&&N&&A)return(0,te().Rf)({collectionViewBlockStore:D,collectionStore:N,instanceMap:A})}),[N,D,A]);F||(c??="Loading collection dependencies");const P=function(e,t){const o=(0,r().v3)(),l=null==e?void 0:e.id,i=null==e?void 0:e.firstTableViewId,a="collection_group_results",[s,p]=(0,n.useState)(0);(0,n.useEffect)((()=>{if(!l)return;const e=new(g().C)(o,(0,h().eG)(l),(()=>{p((e=>e+1))}));return e.subscribe(),()=>{e.unsubscribe()}}),[l,o]);const c=(0,f().lW)(s,250,Object.is),[d]=(0,y().Yb)((async()=>{if(!i||!l||!t)return;const e=await w().callApi({eventName:"queryCollection",environment:o,data:{collectionView:{spaceId:t,id:i},source:{type:"collection",id:l,spaceId:t},loader:{filter:{operator:"or",filters:void 0},reducers:{[a]:{type:"results",limit:re}},searchQuery:"",sort:[],userId:o.currentUser.id,userTimeZone:(0,v().P)()}}}),n=[];if("success"===e.type){const t=e.data.result.reducerResults[a];if("results"===t.type){const{blockIds:o}=t,l=I().RecordMapWithRole.create(e.data.recordMap);for(const e of o){const t=l.getModel({table:"block",id:e});t&&n.push({properties:t.getProperties(),icon:t.getFormat().page_icon})}}}return n}),[l,c,o,i,t]);return d.value}(F,V);P||(c??="Loading example rows"),x&&F&&!F.templateId&&(p=`Collection "${F.name}" is not an instance of a workflow template`,F=void 0);const{infos:E,errors:L}=function(e){const{spaceId:t,collectionInfo:o,collectionStore:n,instanceMap:l}=e;return(0,i().K8)((()=>{if(!(t&&o&&n&&l))return{infos:void 0,errors:[]};const e=[];for(const n of o.properties)"button"===n.schema.type&&n.schema.automation_id&&e.push({table:ne().yB,id:n.schema.automation_id,spaceId:t});e.push(...o.automationPointers);const r=[],i=[],a=[];for(const s of e){const e=k().dn.createChildStore(n,s);if(!e||!e.isDefined()){i.push(`Loading automation ${s.id}...`);continue}const a=(0,oe()._)({table:"collection",id:o.id}),p=l[a]??{},c=e.getNameWithDefault(le().A.getIntl()),d=e.getModel(),u=[];for(const t of e.getActionStores())t.isDefined()?u.push(t.getModel()):i.push(`Loading action ${t.id}...`);r.push({type:"automation",id:s.id,templateId:(0,te().SU)(p,"automation",e.id),spaceId:t,name:c,referrerName:(0,ee().PT)(c),automationModel:d,automationActionModels:u})}return i.length>0||a.length>0?{infos:void 0,errors:a}:{infos:r,errors:a}}),[o,n,l,t])}({spaceId:V,collectionInfo:F,collectionStore:N,instanceMap:A});E||(c??="Loading automations");const{infos:W,errors:K}=pe({spaceId:V,collectionInfo:F,collectionStore:N,instanceMap:A});W||(c??="Loading page templates");const U=(0,n.useMemo)((()=>{var e;const t=null===(e=F)||void 0===e?void 0:e.templateId;if(!t)return;const o=T.get(t);return"collection"===(null==o?void 0:o.type)?o:void 0}),[null===(s=F)||void 0===s?void 0:s.templateId,T]),X=(0,n.useMemo)((()=>{if(!U||!F)return[];return(0,q().bQ)(U).map((e=>{const t=T.get(e);if("compound"===(null==t?void 0:t.type))return t})).filter(H().O9)}),[F,U,T]),ie=(0,n.useMemo)((()=>{var e;return[...X.map((e=>({type:"compound",id:e.templateId,name:e.name,templateId:e.templateId}))),...(null===(e=u.newCompoundTemplates)||void 0===e?void 0:e.map((e=>({type:"compound",id:e.id,name:e.initialName,templateId:void 0}))))??[]]}),[X,u.newCompoundTemplates]),{uninstantiatedFeatures:ae,instantiatedFeatures:se}=(0,n.useMemo)((()=>{if(!F||!E||!W)return{instantiatedFeatures:[],uninstantiatedFeatures:[]};const e=[...F.properties,...F.collectionViews,...ie,...W,...E,F.layout].filter(H().O9);if(!U)return{instantiatedFeatures:e,uninstantiatedFeatures:[]};const t=new Set(e.map((e=>e.templateId)).filter(H().O9));return{instantiatedFeatures:e,uninstantiatedFeatures:(0,q().bQ)(U).filter((e=>!t.has(e))).map((e=>{const t=T.get(e);if(t)return{type:"uninstantiated_template",id:t.templateId,templateId:t.templateId,name:(0,Q().getWorkflowTemplateName)(t)}})).filter(H().O9)}}),[E,F,ie,W,U,T]),ce=(0,n.useMemo)((()=>[...se,...ae]),[se,ae]),de=(0,n.useMemo)((()=>{const e=new Map;return F?([F,...ce].forEach((t=>{t.templateId&&e.set(t.templateId,(0,ee().vO)(t))})),e):e}),[ce,F]),ue=(0,n.useMemo)((()=>{const e=new Map;return F&&W?([F,...ce,...W].forEach((t=>{e.set((0,ee().vO)(t),t)})),e):e}),[ce,F,W]),me=(0,n.useMemo)((()=>{if(!F)return[];const e=ce.map((e=>(0,ee().vO)(e))),t=new Set(e),o=(U?(0,q().bQ)(U):[]).map((e=>de.get(e))).filter(H().O9),n=(0,G().sb)(u.featureOrdering??[]).filter((e=>t.has(e))),l=new Set(n),r=F.tableOrderPropertyIds.map((e=>{const t=(0,ee().vO)({type:"property",id:e});if(ue.has(t))return t})).filter(H().O9),i=e=>{for(const t of e)l.has(t)||(n.push(t),l.add(t))};i(o),i(r),i(e);return function(e,t){const o=new Set(t);e=e.filter((e=>o.has(e)));const n=new Set(e),l=[];for(const r of t)if(n.has(r)){const t=e.shift()??r;l.push(t)}else l.push(r);return l}(F.collectionViews.map((e=>(0,ee().vO)(e))),n)}),[ce,F,ue,U,u.featureOrdering,de]),fe=(0,n.useMemo)((()=>null!=D&&D.pointer&&V?{...null==D?void 0:D.pointer,spaceId:V}:void 0),[null==D?void 0:D.pointer,V]);"en-US"!==(0,z().tz)().locale&&(p??="You must be on the English locale to use the builder.");return(0,n.useMemo)((()=>{if(!p&&F&&fe&&N&&E&&W){var e;return{type:"loaded",context:{state:u,dispatch:m,templateRegistryMap:T,templateProvider:j,templateIdToBuilderKeyMap:de,featureInfoMap:ue,collectionInfo:F,sourceCollectionTemplate:U,isOriginalSourceCollectionViewBlock:Boolean(U&&(null===(e=U.builderMetadata)||void 0===e?void 0:e.sourceCollectionViewBlock)&&J().L3.isEqual(U.builderMetadata.sourceCollectionViewBlock,fe)),exampleRows:P,compoundTemplateInfos:ie,collectionStore:N,featureOrdering:me,uninstantiatedFeatures:ae,allIcons:b,pageTemplatesInfos:W,pageTemplatesErrors:K,automationInfos:E,automationErrors:L,sourceCollectionViewBlockPointer:fe}}}return null!=u&&u.url?p?{type:"error",message:p,collectionId:$,collectionViewBlockId:M}:{type:"loading",message:c,collectionId:$,collectionViewBlockId:M}:{type:"emptyInput"}}),[F,fe,N,E,W,u,p,c,$,M,m,T,j,de,ue,U,P,ie,me,ae,b,K,L])}de.displayName="BuilderContext";var fe=()=>o(428045);function ye(){const e=(0,z().tz)(),t=(0,i().K8)((()=>{var t;const o=(null===(t=V().A.state)||void 0===t?void 0:t.templatesWithRowIds.map((e=>e.template)))??[],n=(0,fe().Cb)(e,{localizeTemplates:!1,stage:"next"}),l=new Map;for(const e of n)l.set(e.templateId,e);for(const e of o)l.set(e.templateId,e);return l}),[e]),o=(0,n.useMemo)((()=>new(q().GH)((e=>{const o=t.get(e);if(!o)throw new Error(`Template not found in builder context: "${e}"`);return o}))),[t]);return(0,n.useMemo)((()=>({templateRegistryMap:t,templateProvider:o})),[o,t])}var he=()=>o(191742),ge=()=>o(436572),ve=()=>o(439264);function Ie(e){const{builderContext:t,item:o}=e;if("property"===o.type&&!o.isSupported)return{type:"ignore",reason:"unsupported_property_type"};const n=(0,ee().rW)(t,o);if(n.ignore)return{type:"ignore",reason:"ignore_checkbox_is_checked"};if("uninstantiated_template"===o.type)return n.isDeleted?{type:"ignore",reason:"deleted"}:{type:"mapToTemplateId",templateId:o.templateId,includeInCollectionTemplate:!0};const l=n.templateId??"";return l?n.isDeleted?{type:"ignore",reason:"deleted"}:t.state.createCopy&&!n.bypassCreateCopy&&t.templateRegistryMap.has(l)?{type:"invalidCopyName"}:n.shouldMapToTemplate?{type:"mapToTemplateId",templateId:l,includeInCollectionTemplate:n.includeInCollectionTemplate}:{type:"createOrUpdateTemplate",templateId:l,includeInCollectionTemplate:n.includeInCollectionTemplate}:{type:"ignore",reason:"empty_template_id"}}o(672577);var be=o.n(o(625473)),we=()=>o(104119),xe=(o(737550),o.n(o(794148))),Te=()=>o(99895),je=()=>o(713998),ke=()=>o(522419),Ce=()=>o(278238),Se=()=>o(669647);const Oe=new Set(["designGoalsCollection","habitTrackerCollection","meetingOneOnOnesCollection","notesCollection","tasksCollectionForNewUserExperiment","feedbackTrackerCollection","complianceTrackerCollection"]);function Me(e){return"select"===e.type||"multi_select"===e.type}function _e(e){const{templateId:t,validatorName:o,validatorTestName:n,message:l}=e;return`${[t,o,n].filter(H().O9).join(" -> ")}: ${l}`}class Be{constructor(e){this.templates=void 0,this.templatesRegistry=new Map,this.validators=[],this.currentTemplateId=void 0,this.currentValidatorName=void 0,this.currentValidatorTestName=void 0,this.pipelineStage=void 0,this.errors=[],this.provider=void 0,this.pipelineStage=e.pipelineStage,this.templates=e.templatesToValidate;const t=[...e.templatesToValidate,...e.templatesRegistry??[]];for(const o of t)this.templatesRegistry.has(o.templateId)||this.templatesRegistry.set(o.templateId,o);this.provider=new(q().GH)(this.getWorkflowTemplateFromId.bind(this))}getWorkflowTemplateFromId(e){const t=this.templatesRegistry.get(e);return xe().ok(t,`Template "${e}" must exist`),t}ensureTemplateIdType(e,t){if(this.getWorkflowTemplateFromId(e).type!==t)throw new Error(`Template "${e}" is not of type "${t}"`)}logInvalidTemplateIds(e){for(const t of e??[])this.templatesRegistry.has(t)||this.log("error",`Template id "${t}" does not exist`)}captureExceptions(e,t){try{t()}catch(o){if(o instanceof Error)return void this.log(e,o.message);throw o}}test(e,t){this.testWithLevel("error",e,t)}testWarning(e,t){this.testWithLevel("warning",e,t)}testWithLevel(e,t,o){if(!this.currentTemplateId||!this.currentValidatorName)throw new Error("This method should only be run from a validator");this.currentValidatorTestName=t,this.captureExceptions(e,o),this.currentValidatorTestName=void 0}log(e,t){if(!this.currentTemplateId||!this.currentValidatorName)throw new Error("This method should only be run from a validator");this.errors.push({level:e,templateId:this.currentTemplateId,validatorName:this.currentValidatorName,validatorTestName:this.currentValidatorTestName,message:t})}addValidator(e,t){this.validators.push({name:e,validator:t})}run(){for(const e of this.templates){this.currentTemplateId=e.templateId;for(const{name:t,validator:o}of this.validators)this.currentValidatorName=t,this.captureExceptions("error",(()=>o(this,e))),this.currentValidatorName=void 0;this.currentTemplateId=void 0}}}function Ve(e){const t=new(Te().G)((()=>0));for(const n of e){const e=t.get(n);t.set(n,e+1)}const o=[];for(const[n,l]of t.entries())l>1&&o.push(`${n} (${l})`);if(o.length>0)throw new Error(`Duplicates found: ${o.join(", ")}`)}var $e=()=>o(496603),Ne=()=>o(731638);function Re(e){const{builderContext:t,item:o}=e,n=Ie({builderContext:t,item:o});if(!n.templateId)return;const{templateId:l}=n;if(o.templateId===l)return;const r=function(e,t){switch(e.type){case"uninstantiated_template":case"compound":return;case"collection":return{type:"collection",id:e.id};case"collection_view":return{type:"collection_view",id:e.id};case"layout":return{type:"layout",id:e.id,spaceId:e.spaceId};case"property":return{type:"property",id:e.id,collectionId:t.id};case"block":return{type:"block",id:e.id,spaceId:e.spaceId};case"automation":return{type:"automation",id:e.id,spaceId:e.spaceId};default:(0,H().HB)(e)}}(o,t.collectionInfo);if(!r)return;return(0,te().fn)(t.collectionInfo.templateIdToInstancePointersMap,r.type,r.id)?{type:"update",pointer:r,templateId:l}:{type:"create",pointer:r,templateId:l}}var Ae=()=>o(192845),De=()=>o(977345),Fe=()=>o(519831),Pe=()=>o(869558);function Ee(e){let{schema:t,collectionViewType:o,primitiveFormat:n}=e;const l={collection_view_icon:n.collection_view_icon,collection_group_by:n.collection_group_by,collection_groups:Le(n.collection_groups),property_filters:n.property_filters,collection_group_aggregation:n.collection_group_aggregation,hide_linked_collection_name:n.hide_linked_collection_name,collection_peek_mode:n.collection_peek_mode,description:n.description,show_page_icon:n.show_page_icon,collection_view_default_template:n.collection_view_default_template};for(const[i,a]of Object.entries(n))i.startsWith(o)&&(i.endsWith("_properties")&&Array.isArray(a)?l[i]=(r=a,r.filter((e=>!1!==e.visible))).filter((e=>Boolean(t[null==e?void 0:e.property]))):l[i]=a);var r;return l}function Le(e){if(e&&e.length>0)return e}function We(e){var t;let{collectionViewTemplateValue:o,mapper:n}=e;const l={};var r;"object"==typeof(null===(t=o.format)||void 0===t?void 0:t.collection_view_default_template)&&n.populateDependencyMap((0,ee().vO)({type:"block",id:null===(r=o.format)||void 0===r?void 0:r.collection_view_default_template.template_page_id}),l);(0,q().$G)({object:o,callback:e=>{const t=e.property;n.populateDependencyMap((0,ee().vO)({type:"property",id:t}),l)}});const{query2:i}=o;if(i)for(const a of q().Nf){const e=i[a];e&&n.populateDependencyMap((0,ee().vO)({type:"property",id:e}),l)}return l}var Ke=()=>o(476219);const Ue="__self__";function qe(e){const{collectionInfo:t,compoundTemplateInfos:o,pageTemplatesInfos:n,automationInfos:l}=e,r={templateOutputs:[],instanceActions:[],errors:[],warnings:[],debugMessages:[],counts:{new:0,changed:0,unchanged:0},hasNewOrChangedTemplates:!1,fakeLocalizedTemplates:void 0},i=new Map;for(const[f,y]of e.featureInfoMap.entries()){const t=Ie({builderContext:e,item:y});t.templateId&&i.set(f,t.templateId)}let a;for(const f of t.collectionViews)f.isFirstTableView&&(a=f);for(const f of t.properties){const o=Ie({builderContext:e,item:f});"createOrUpdateTemplate"===o.type&&Je({builderContext:e,propertyInfo:f,templateId:o.templateId,collectionInfo:t,builderKeyToTemplateIdMap:i,firstTableViewInfo:a,output:r})}for(const f of t.collectionViews){const t=Ie({builderContext:e,item:f});"createOrUpdateTemplate"===t.type&&ze({builderContext:e,collectionViewInfo:f,templateId:t.templateId,builderKeyToTemplateIdMap:i,output:r})}for(const f of n){const t=Ie({builderContext:e,item:f});"createOrUpdateTemplate"===t.type&&Ge({builderContext:e,blockInfo:f,builderKeyToTemplateIdMap:i,templateId:t.templateId,output:r})}for(const f of l){const t=Ie({builderContext:e,item:f});"createOrUpdateTemplate"===t.type&&He({builderContext:e,automationInfo:f,builderKeyToTemplateIdMap:i,templateId:t.templateId,output:r})}for(const f of o){const t=Ie({builderContext:e,item:f});"createOrUpdateTemplate"===t.type&&Xe({builderContext:e,compoundTemplateInfo:f,templateId:t.templateId,output:r})}const s=t.layout;if(s){const t=Ie({builderContext:e,item:s});"createOrUpdateTemplate"===t.type&&function(e){const{builderContext:t,layoutInfo:o,templateId:n,output:l,builderKeyToTemplateIdMap:r}=e,i={},a=new Qe(n,r,t.featureInfoMap,l),s=(0,Ne().CF)(o.layout);for(const d of s)a.populateDependencyMap(d,i);const p=(0,ee().rW)(t,o),c={templateId:n,type:"layout",name:p.name,value:o.layout,dependencyMap:i};Ye(t,l,c,o)}({builderContext:e,layoutInfo:s,templateId:t.templateId,builderKeyToTemplateIdMap:i,output:r})}const p=Ie({builderContext:e,item:t});"createOrUpdateTemplate"===p.type&&function(e){const{builderContext:t,collectionInfo:o,builderKeyToTemplateIdMap:n,templateId:l,output:r}=e,i=(0,ee().rW)(t,o),a=t.featureOrdering.map((e=>{const o=t.featureInfoMap.get(e);if(!o)return;const n=Ie({builderContext:t,item:o});return"ignore"!==n.type&&"invalidCopyName"!==n.type&&n.includeInCollectionTemplate?{item:o,settings:(0,ee().rW)(t,o),templateId:n.templateId}:void 0})).filter(H().O9),s=o.format?{collection_default_template:o.format.collection_default_template,item_name_config_v2:o.format.item_name_config_v2}:void 0,p={},c=new Qe(l,n,t.featureInfoMap,r);"object"==typeof(null==s?void 0:s.collection_default_template)&&c.populateDependencyMap((0,ee().vO)({type:"block",id:s.collection_default_template.template_page_id}),p);for(const u of t.exampleRows??[])for(const e in u.properties)c.populateDependencyMap((0,ee().vO)({type:"property",id:e}),p);const d={type:"collection",description:i.description||o.descriptionAsString,category:(0,ee().To)(i.category),value:{targetCollection:{name:o.name,icon:o.icon??ee().Jp,description:o.description,itemName:{singular:i.singularItemName,plural:i.pluralItemName},format:s},exampleRows:t.exampleRows,templateItems:a.map((e=>({pointer:e.templateId,optionality:e.settings.optionality,isInSettings:!!e.settings.isInSettings||void 0}))),onboarding:{isMinimal:i.hasMinimalOnboarding}},templateId:l,dependencyMap:p,builderMetadata:{env:"production",sourceCollectionViewBlock:t.sourceCollectionViewBlockPointer,sourceFirstTableViewId:o.firstTableViewId}};Ye(t,r,d,o)}({builderContext:e,collectionInfo:t,builderKeyToTemplateIdMap:i,templateId:p.templateId,output:r});const c=r.templateOutputs.map((e=>e.template)),d=(0,z().EY)({locale:"fr",defaultLocale:"en-US",messages:{}});try{r.fakeLocalizedTemplates=(0,we().IC)({},d,c,{shouldFakeLocalization:!0,strict:!1})}catch(m){if(!(m instanceof Error))throw m;r.warnings.push(`Some content may need engineering support to be made localizable: ${m.message}`)}const u=function(e){const t=new Be(e);return t.addValidator("template contains no template instance metadata",((e,t)=>{const o=["workflow_template_instance","compound_workflow_template_instances"],n=JSON.stringify(t);for(const l of o)n.includes(l)&&e.log("warning",`Template JSON contains "${l}"--are we properly removing instance metadata from our primitives?`)})),t.addValidator("dependency map",((e,t)=>{"dependencyMap"in t&&(e.test("contains valid template IDs",(()=>{e.logInvalidTemplateIds(Object.values(t.dependencyMap??{}))})),e.test("is declared on templates with dependencies",(()=>{"collection_view"!==t.type&&"layout"!==t.type||xe().ok(void 0!==t.dependencyMap)})))})),t.addValidator("property template is valid",((e,t)=>{"property"===t.type&&(e.test("relationCollectionTemplateId is only set for relation property template",(()=>{xe().equal(void 0!==t.relatedCollectionTemplateId,"relation"===t.value.type),t.relatedCollectionTemplateId&&e.ensureTemplateIdType(t.relatedCollectionTemplateId,"collection")})),e.test("buttonAutomationId is only set for button property template",(()=>{xe().equal(void 0!==t.buttonAutomationId,"button"===t.value.type),t.buttonAutomationId&&e.ensureTemplateIdType(t.buttonAutomationId,"automation")})),e.test("propertyOptionsType is set correctly",(()=>{xe().equal(void 0!==t.propertyOptionsType,Me(t.value))})))})),t.addValidator("contains no files",((e,t)=>{const o=(t,o)=>{const n=(0,je().pJ)(o).filter((e=>(0,ke().Nh)(e.url))).map((e=>`${e.name} (${e.url})`)).join(", ");n.length>0&&e.log("error",`${t} contains files: ${n}`)},n=(e,t)=>{for(const[n,l]of Object.entries(t??{}))o(`${e} property "${n}"`,l)};if("collection"===t.type)(t.value.exampleRows??[]).forEach(((e,t)=>{n(`Example row ${t}`,e.properties)}));else if("block"===t.type){const e=I().RecordMap.create(t.value.recordMap);for(const t of e.getModelsByTable("block"))n(`Block ${t.id}`,t.getProperties())}})),t.addValidator("compound template is valid",((e,t)=>{"compound"===t.type&&(e.test("contains valid templates",(()=>{for(const o of t.value.templateItems){const t=e.getWorkflowTemplateFromId(o.pointer);xe().ok((0,q().$K)(t))}})),e.test("contains two or more templates",(()=>{const e=t.value.templateItems.length;xe().ok(e>=2)})),e.test("has notion static icon",(()=>{xe().ok((0,Ce().T8)(t.icon))})),e.test("has no duplicate template IDs",(()=>{Ve(t.value.templateItems.map((e=>e.pointer)))})),e.test("contains all its dependencies",(()=>{for(const o of t.value.templateItems){const n=e.getWorkflowTemplateFromId(o.pointer);if((0,q().$K)(n)){const l=(0,q().Z6)({template:n});for(const n of l){if("collection"===e.getWorkflowTemplateFromId(n.templateId).type)continue;const l=t.value.templateItems.find((e=>e.pointer===n.templateId));l||e.log("warning",`Compound template has explicit dependency "${o.pointer}", which depends on "${n.templateId}" (via ${n.debugSource}). However, the latter is not part of the compound template--it should be!`)}}}})))})),t.addValidator("collection template is valid",((e,t)=>{if("collection"!==t.type)return;const o=(0,q().bQ)(t),n=o.map((t=>e.getWorkflowTemplateFromId(t)));e.testWarning("has description",(()=>{xe().ok(t.description,"collection template should specify description so it'll look nice in suggestions & during onboarding")})),e.test("has valid templateItems",(()=>{for(const o of t.value.templateItems){const t=e.getWorkflowTemplateFromId(o.pointer);xe().ok(t,`No template found for ID ${o.pointer}`),xe().ok((0,q().Jb)(t),`${o.pointer} is not of FeatureTemplate type`),o.isInSettings&&(xe().ok((0,q().bz)(t),`${o.pointer} is not of FeatureTemplateInSettings type`),xe().ok("compound"!==t.type,"Compound template cannot have isInSettings set to true"))}})),e.test("has no duplicate templates across all available template IDs",(()=>{Ve(o)})),e.test("doesn't have two or more relation properties pointing to the same collection preset",(()=>{Ve(n.filter(q().Sz).map((e=>e.relatedCollectionTemplateId)))})),e.test("has valid category",(()=>{t.category&&xe()(Se().RX.includes(t.category))})),e.test("has notion static icon",(()=>{xe().ok((0,Ce().T8)(t.value.targetCollection.icon))}));const l=t.value.templateItems.map((t=>({template:e.getWorkflowTemplateFromId(t.pointer),templateItem:t})));e.test("has at most one title property template, which is required",(()=>{const e=l.filter((e=>"property"===e.template.type&&"title"===e.template.value.type));xe().ok(e.length<=1),1===e.length&&xe().ok("required"===e[0].templateItem.optionality)}));const r=t.value.templateItems.filter((t=>"collection_view"===e.getWorkflowTemplateFromId(t.pointer).type)),i=(0,q().A6)(t,e.provider);e.test("contains no required collection_view templates",(()=>{const e=r.filter((e=>"required"===e.optionality)).map((e=>e.pointer));xe().deepStrictEqual(e,[])})),(0,q().cB)(t.templateId)||("next"!==e.pipelineStage&&"M3_3"!==e.pipelineStage||Oe.has(t.templateId)||e.test("contains at least 3 collection_view templates, with 1 optionalDefaultOff",(()=>{r.length<3&&e.log("warning","A collection template should contain at least 3 collection_view templates."),r.some((e=>"optionalDefaultOff"===e.optionality))||e.log("warning","At least one collection_view template should be optionalDefaultOff, to avoid confusing users in the view step.")})),e.test("contains at least 1 collection_view template that is optionalDefaultOn, and is of a supported type",(()=>{xe().ok(i.length>0,"must have at least one default-on view");const t=i[0].value.type;(0,Se().QE)(t)||e.log("warning",`Unsupported default view type "${t}" (engineering will need to add thumbnail support for it).`)})),e.test("has at least one default-on table collection view",(()=>{const t=i.some((e=>"table"===e.value.type));t||e.log("warning","Template has no default-on table views. For user comprehension, we should always be shipping at least one default-on table view per collection.")})),e.test("no people properties assigned to a user",(()=>{(t.value.exampleRows??[]).forEach(((o,n)=>{for(const[r,i]of Object.entries(o.properties??{})){var l;const o=(0,q().Ir)("property",r),i=null===(l=t.dependencyMap)||void 0===l?void 0:l[o];if(!i)continue;const a=e.provider.fromId(i);(0,q().Xq)(a,"property")&&"person"===a.value.type&&e.log("warning",`Example row ${n} has non-empty person property: ${a.value.name}`)}}))})),"next"!==e.pipelineStage&&"M3_3"!==e.pipelineStage||Oe.has(t.templateId)||e.test("all default off collection views show after the default-on collection views",(()=>{const o=new Set((0,q().Mt)({featureTemplateItems:t.value.templateItems,optionality:"optionalDefaultOn",type:"collection_view",provider:e.provider})),n=e.provider.allOfType({templateIds:t.value.templateItems.map((e=>e.pointer)),type:"collection_view"}).findIndex((e=>!o.has(e.templateId)));-1!==n&&n<=o.size-1&&e.log("warning","Default-off collection views should show after the default-on collection views.")})))})),t.run(),t.errors}({templatesToValidate:r.templateOutputs.map((e=>e.template)),templatesRegistry:Array.from(e.templateRegistryMap.values()),pipelineStage:"next"});for(const f of u){const e=_e(f);"error"===f.level?r.errors.push(e):"warning"===f.level?r.warnings.push(e):(0,H().HB)(f.level)}for(const f of r.templateOutputs){const{templateId:e}=f.template;"unchanged"!==f.type&&fe().eX.has(e)&&r.errors.push(`"${e}" is a built-in system template and can't be changed! Consider changing its template id so a new template is created.`)}return r.instanceActions.push(...function(e){const t=[];for(const o of e.featureInfoMap.values()){const n=Re({builderContext:e,item:o});n&&t.push(n)}return t}(e)),r}function Je(e){const{builderContext:t,templateId:o,propertyInfo:n,firstTableViewInfo:l,collectionInfo:r,builderKeyToTemplateIdMap:i,output:a}=e,s=(0,ee().rW)(t,n);let p=s.relatedCollectionTemplateId;if(p===Ue){const e=Ie({builderContext:t,item:r});if(e.templateId)p=e.templateId;else{const e=`In property "${n.name}", unable to obtain template id for self-relation.`;a.errors.push(e),p=e}}const c=Ke().nN(n.schema);let d;if("button"===c.type){const{automation_id:e}=c;if(e){const o=t.featureInfoMap.get((0,ee().vO)({type:"automation",id:e}));if(o){d=Ie({builderContext:t,item:o}).templateId,delete c.automation_id}}if(!d){const e=`In property "${n.name}", unable to obtain template id for automation.`;a.errors.push(e),d=e}}const u={templateId:o,type:"property",value:c,relatedCollectionTemplateId:p,buttonAutomationId:d,propertyOptionsType:Me(c)?null==s?void 0:s.propertyOptionsType:void 0,dependencyMap:Ke().vW({propertyTemplateValue:c,mapper:new Qe(o,i,t.featureInfoMap,a)})};"relation"!==n.schema.type&&Ke().Kg({propertyId:n.id,propertyTemplate:u,firstTableViewInfo:l}),Ye(t,a,u,n)}function ze(e){const{builderContext:t,collectionViewInfo:o,templateId:n,builderKeyToTemplateIdMap:l,output:r}=e;if(!o.viewType)return void r.errors.push(`Collection "${o.name}" has no type.`);const i={type:o.viewType,name:o.name,format:Ee({schema:t.collectionInfo.schema,collectionViewType:o.viewType,primitiveFormat:o.format}),query2:o.query};Ye(t,r,{templateId:n,type:"collection_view",value:i,dependencyMap:We({collectionViewTemplateValue:i,mapper:new Qe(n,l,t.featureInfoMap,r)})},o)}function He(e){const{builderContext:t,builderKeyToTemplateIdMap:o,automationInfo:n,templateId:l,output:r}=e,i={},a=new Qe(l,o,t.featureInfoMap,r),s=new Set,p=new Map,{automationModel:c,builderKeys:u}=function(e){const t=new Set,{value:o}=(0,Ae().n)({automationModel:e,visitors:{visitCollectionProperty:e=>(t.add((0,ee().vO)({id:e,type:"property"})),{type:"keep"}),visitRecordPointer:e=>(e.table!==ae().ev&&e.table!==Fe().Vl&&e.table!==ne().yB&&e.table!==Pe().Gy||t.add((0,ee().vO)({id:e.id,type:e.table})),{type:"keep"})}});return{automationModel:o,builderKeys:t}}(n.automationModel),m=c.getTrigger();u.forEach((e=>s.add(e)));const f=n.automationActionModels.map(((e,o)=>{const{automationActionModel:n,builderKeys:r}=function(e){const{actionIdToActionPlaceholderIdMap:t,automationActionModel:o,spaceId:n}=e,l=new Set;function r(e){const o=(0,De().y5)(e);if("action"===o.source){const e=t.get(o.action_id)??o.action_id;return(0,De().$y)({...o,action_id:e})}if("global"===o.source)return e;(0,H().HB)(o)}const{value:i}=(0,Ae().G)({automationActionModel:o,baseUrl:d().A.domainBaseUrl,preventClearingConfig:!0,publicDomainName:d().A.publicDomainName,sourceSpaceId:n,visitors:{visitCollectionProperty:e=>(l.add((0,ee().vO)({id:e,type:"property"})),{type:"keep"}),visitCollectionPropertyPointer:e=>(l.add((0,ee().vO)({id:e.propertyId,type:"property"})),l.add((0,ee().vO)({id:e.id,type:"collection"})),{type:"keep"}),visitFormulaContextValue:e=>({type:"replace",value:r(e)}),visitFormulaPageProperty:e=>{if(l.add((0,ee().vO)({id:e.property,type:"property"})),"collection"in e&&e.collection)l.add((0,ee().vO)({id:e.collection.id,type:"collection"}));else if("contextValueId"in e&&e.contextValueId){const t=(0,$e().mg)(e);return t.contextValueId=r(t.contextValueId),{type:"replace",value:t}}return{type:"keep"}},visitRecordPointer:e=>(e.table!==ae().ev&&e.table!==Fe().Vl&&e.table!==ne().yB&&e.table!==Pe().Gy||l.add((0,ee().vO)({id:e.id,type:e.table})),{type:"keep"})}});return{automationActionModel:i,builderKeys:l}}({actionIdToActionPlaceholderIdMap:p,automationActionModel:e,spaceId:t.collectionStore.getSpaceId()});r.forEach((e=>s.add(e)));const i=function(e,t){const o=e.getType();return{type:o,config:e.getConfig(),placeholderId:`${t}:${o}`}}(n,`${l}:${o}`);return p.set(n.id,i.placeholderId),i}));for(const d of s)a.populateDependencyMap(d,i);const y={type:"automation",templateId:l,value:{actions:f,name:n.name,trigger:m},dependencyMap:i};return Ye(t,r,y,n),y}function Ge(e){var t;const{builderContext:o,builderKeyToTemplateIdMap:n,blockInfo:l,templateId:r,output:i}=e,a=(0,ee().rW)(o,l),s={};!function(e){const{propertyIds:t,builderKeyToTemplateIdMap:o,output:n,dependencyMap:l}=e;for(const r of t){const e=o.get((0,ee().vO)({type:"property",id:r}));e?l[`property:${r}`]=e:n.errors.push(`In template "${e}", unable to find mapping for property "${r}".`)}}({propertyIds:Array.from(l.propertyIds),dependencyMap:s,builderKeyToTemplateIdMap:n,output:i});const p=l.recordMap.toJson();if(!(0,I().isRecordMapJsonV3)(p))return void i.errors.push("recordMap.toJson() is not V3!");const c=null===(t=p.block)||void 0===t?void 0:t[l.id];var d,u;c&&"page"===c.value.type?null!==(d=c.value.format)&&void 0!==d&&d.workflow_template_instance&&(c.value=(0,$e().mg)(c.value),null===(u=c.value.format)||void 0===u||delete u.workflow_template_instance):i.errors.push(`Page template "${r}" has no root block!`);const m={templateId:r,type:"block",description:a.description,value:{blockPointer:{table:ae().ev,id:l.id,spaceId:o.collectionStore.getSpaceId()},recordMap:p},dependencyMap:s};Ye(o,i,m,l)}function Xe(e){const{builderContext:t,compoundTemplateInfo:o,output:n,templateId:l}=e,r=(0,ee().rW)(t,o);Ye(t,n,{type:"compound",templateId:l,name:r.name,icon:r.icon,value:{templateItems:r.templateItems.map(((e,o)=>{if(!e.pointer)return void n.errors.push(`In "${l}", template item at index ${o} is undefined`);const r=t.featureInfoMap.get(e.pointer);if(!r)return void n.errors.push(`In "${l}", unable to resolve pointer "${e.pointer}"`);const i=Ie({builderContext:t,item:r});if("createOrUpdateTemplate"===i.type||"mapToTemplateId"===i.type)return{pointer:i.templateId,optionality:e.optionality};n.errors.push(`In "${l}", builder action for "${e.pointer}" is "${i.type}"`)})).filter(H().O9)}},o)}function Ye(e,t,o,n){const{templateId:l}=o,r=e.templateRegistryMap.get(l);if(r){const{version:e,copiedFrom:n,...l}=r,i=be()(l,{space:"  "}),a=be()(o,{space:"  "});if(i===a)t.counts.unchanged+=1,t.templateOutputs.push({type:"unchanged",template:{...o,version:e,copiedFrom:n}});else{const l=(e??0)+1;t.hasNewOrChangedTemplates=!0,t.counts.changed+=1,t.templateOutputs.push({type:"changed",newVersion:l,template:{...o,version:l,copiedFrom:n},originalTemplate:r,templateJson:a,originalTemplateJson:i})}}else t.hasNewOrChangedTemplates=!0,t.counts.new+=1,t.templateOutputs.push({type:"new",template:{...o,copiedFrom:e.state.createCopy?n.templateId:void 0}})}class Qe{constructor(e,t,o,n){this.templateId=e,this.builderKeyToTemplateIdMap=t,this.featureInfoMap=o,this.output=n}map(e){const t=this.builderKeyToTemplateIdMap.get(e);return t||(this.output.errors.push(`In template "${this.templateId}", "${e}" has no template id mapping.`),`🚨TEMPLATE ID MAPPING NOT FOUND FOR "${e}"🚨`)}populateDependencyMap(e,t){if(e===ee().rs)return void this.output.debugMessages.push(`"${e}" is a special property and will not be mapped to a template id.`);const o=this.featureInfoMap.get(e),n=this.map(e);o?"compound"!==o.type&&"uninstantiated_template"!==o.type?t[`${o.type}:${o.id}`]=n:this.output.errors.push(`"${e}" has invalid feature type: "${o.type}"`):this.output.errors.push(`"${e}" has no feature info`)}}function Ze(e,t){const o=e.templateOutputs.map((e=>e.template)),n=o.find((e=>"collection"===e.type));if(!n)return;return{collectionTemplate:n,templateProvider:new(q().GH)((e=>{const n=o.find((t=>t.templateId===e));return n||t.templateProvider.fromId(e)}))}}function et(e){const t=(0,a().IS)((e=>({code:{fontFamily:"monospace",backgroundColor:e.lightGrayButtonHoveredBackground,padding:2,borderRadius:4}})),[]);return(0,E.jsx)("code",{style:t.code,children:e.children})}function tt(e){let{children:t,style:o,type:n="default"}=e;const l=(0,a().IS)((e=>({details:{border:`1px solid ${e.regularDividerColor}`,padding:10,borderRadius:4,..."subtle"===n&&{border:"none",margin:4},..."superSubtle"===n&&{border:"none",margin:"none",padding:0},...o}})),[n,o]);return(0,E.jsx)("details",{style:l.details,children:t})}function ot(e){let{children:t}=e;const[o,l]=(0,n.useState)(!1),r=(0,n.useCallback)((()=>l(!0)),[]),i=(0,n.useCallback)((()=>l(!1)),[]),s=(0,a().IS)((e=>({itemContainer:{display:"flex",alignItems:"stretch",justifyContent:"stretch",padding:2,borderRadius:4,backgroundColor:o?e.outlineButtonHoveredBackground:"transparent",marginBottom:4,width:"100%"},item:{paddingTop:2,paddingBottom:2,paddingLeft:4,fontSize:12,flexGrow:1},borderItem:{width:4,borderRadius:2,backgroundColor:e.stroke.grayPrimary}})),[o]);return(0,E.jsxs)("div",{onMouseEnter:r,onMouseLeave:i,style:s.itemContainer,children:[(0,E.jsx)("div",{style:s.borderItem}),(0,E.jsx)("div",{style:s.item,children:t})]})}const nt=n.memo(ot);var lt=()=>o(925907),rt=()=>o(939768),it=()=>o(285790),at=()=>o(187485);function st(e){const t=(0,z().tz)(),o=(0,a().IS)((e=>({container:{display:"inline-flex",alignItems:"center",gap:2},link:{display:"inline-block",textDecoration:"underline",color:e.text.blueSecondary}})),[]),n=(0,E.jsx)(at().A,{href:e.href,style:o.link,external:e.openInNewTab,children:e.children});let l=(0,rt().Jf)({str:e.href,allowNoProtocol:!0});return"string"==typeof l&&(0,rt().cW)(l)&&(l=(0,rt().pf)({relativeUrl:l,baseUrl:d().A.domainBaseUrl})),l&&e.includeCopyButton?(0,E.jsxs)("span",{style:o.container,children:[n,(0,E.jsx)(it().A,{ariaLabel:t.formatMessage({id:"workflowTemplatesBuilder.uidoc.builderLink.copyButton",defaultMessage:"Copy link"}),icon:lt().n,style:{width:18,height:18},onClick:()=>{navigator.clipboard.writeText(l),ge().D6({label:"Link copied to clipboard"})}})]}):n}var pt=()=>o(493823),ct=()=>o(760217),dt=()=>o(939740),ut=()=>o(14235),mt=()=>o(962730);function ft(e){let{builderContext:t,builderOutputWorld:l,builderKey:r,showType:s}=e;const[p,c]=(0,n.useState)(!1),{featureOptionality:d,featureType:u}=(0,i().K8)((()=>{var e;const o=t.featureInfoMap.get(r),n=(null==o?void 0:o.templateId)&&(null==l?void 0:l.templateProvider.fromId(o.templateId)),i=null==l?void 0:l.collectionTemplate;return{featureOptionality:null==i||null===(e=i.value.templateItems.find((e=>e.pointer===(null==n?void 0:n.templateId))))||void 0===e?void 0:e.optionality,featureType:null==o?void 0:o.type}}),[t.featureInfoMap,r,l]),m=(0,ee().D6)(t,r,{includeType:!1}),f="required"===d?"Required":"optionalDefaultOn"===d?"On":"Off",y=(0,n.useCallback)((()=>{c(!0)}),[]),h=(0,n.useCallback)((e=>{t.dispatch({type:"updateBuilderSettings",key:r,property:"optionality",value:e}),c(!1)}),[t,r]),g=(0,a().IS)((e=>{const t={property:e.fill.blueSecondary,automation:e.fill.brownSecondary,collection_view:e.fill.greenSecondary,compound:e.fill.graySecondary,block:e.fill.purpleSecondary,collection:e.fill.redSecondary,layout:e.fill.orangeSecondary,uninstantiated_template:e.fill.graySecondary}[u??"uninstantiated_template"],n={borderRadius:4,paddingLeft:4,paddingRight:4,backgroundColor:t};return{container:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:4,paddingRight:4},name:o(284371).RC,labels:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:4},optionalityLabel:{...n,color:"light"===e.mode?e.white:e.text.primary,fontSize:12,height:"fit-content",background:"required"===d?e.redButtonBackground:"optionalDefaultOn"===d?e.blueButtonBackground:e.stroke.lightGrayPrimary},optionalityLabelHovered:{background:"required"===d?e.redButtonHoveredBackground:"optionalDefaultOn"===d?e.blueButtonHoveredBackground:e.stroke.lightGraySecondary},optionalityLabelPressed:{background:"required"===d?e.redButtonPressedBackground:"optionalDefaultOn"===d?e.blueButtonPressedBackground:e.stroke.lightGraySecondary},featureTypeLabel:{...n,backgroundColor:t}}}),[d,u]);return(0,E.jsxs)("div",{style:g.container,children:[(0,E.jsx)("div",{style:g.name,children:m}),(0,E.jsxs)("div",{style:g.labels,children:[u&&s(u)&&(0,E.jsx)("div",{style:g.featureTypeLabel,children:u}),(0,E.jsx)(ut().Ay,{trapFocus:!0,origin:(0,E.jsx)(pt().p,{style:g.optionalityLabel,hoveredStyle:g.optionalityLabelHovered,pressedStyle:g.optionalityLabelPressed,onClick:y,children:f}),popupType:ut().nl.Popup,open:p,placementToOrigin:mt().W.Right,alignmentToOrigin:mt().C.Start,onDismiss:()=>c(!1),render:()=>(0,E.jsx)(o(928600).A,{menuType:o(722872).gu.Popup,width:100,children:(0,E.jsx)(dt().Ay,{type:dt().Oh.Vertical,initialFocus:0,sections:[{key:"optionality",render:e=>(0,E.jsx)(o(89924).A,{...e}),items:[yt("required",h),yt("optionalDefaultOn",h),yt("optionalDefaultOff",h)]}]})})})]})]})}function yt(e,t){return{key:e,render:t=>(0,E.jsx)(ct().A,{...t,title:"required"===e?"Required":"optionalDefaultOn"===e?"On":"Off"}),action:()=>t(e)}}const ht=n.memo(ft);var gt=()=>o(896326);function vt(e){const{builderOutputWorld:{collectionTemplate:t,templateProvider:o}}=e,l=(0,i().K8)((()=>t?(0,q().A6)(t,o):[]),[t,o]),r=(0,i().K8)((()=>{const e=o.allOfType({templateIds:t.value.templateItems.map((e=>e.pointer)),type:"collection_view"}),n=Object.fromEntries(t.value.templateItems.map((e=>[o.fromId(e.pointer).templateId,e.optionality])));return e.map((e=>({view:e,optionality:n[e.templateId]})))}),[t.value.templateItems,o]),s=(0,i().K8)((()=>null==t?void 0:t.value.templateItems.map((e=>(0,gt().bd)(e.pointer,e.optionality,o)))),[null==t?void 0:t.value.templateItems,o]),p=(0,n.useMemo)((()=>(0,gt().UA)({collectionViewTemplates:l,featureTemplateSelections:s??[]})),[l,s]),d=(0,a().IS)((e=>{const t={display:"inline-block",paddingLeft:4,paddingRight:4,paddingTop:2,paddingBottom:2,borderRadius:6,fontSize:12};return{featureTemplateSelection:{...t,backgroundColor:e.tint.regular,border:`2px solid ${e.stroke.lightGrayPrimary}`},featureTemplateSelectionSelected:{...t,background:e.stroke.uiBlueSecondary,border:`2px solid ${e.stroke.uiBluePrimary}`},featureTemplateSelectionRequired:{...t,background:e.stroke.uiRedSecondary,border:`2px solid ${e.stroke.uiRedPrimary}`},list:{display:"flex",flexDirection:"column",justifyContent:"flex-start",alignItems:"flex-start",gap:4,margin:0,padding:0}}}),[]);return s&&0!==s.length?(0,E.jsxs)("div",{children:[(0,E.jsx)(c().iK,{children:"Feature selection step preview"}),(0,E.jsx)("aside",{children:"(Items with a blue background mean they are selected by default.)"}),(0,E.jsx)("p",{children:"Properties"}),(0,E.jsx)("ul",{style:d.list,children:p.map((e=>(0,E.jsx)("li",{style:e.selected?d.featureTemplateSelectionSelected:d.featureTemplateSelection,children:(0,Q().getWorkflowTemplateName)(e.template)},e.template.templateId)))}),(0,E.jsx)("p",{children:"Views"}),(0,E.jsx)("ul",{style:d.list,children:r.map((e=>{let{view:t,optionality:o}=e;return(0,E.jsx)("li",{style:"optionalDefaultOn"===o?d.featureTemplateSelectionSelected:"required"===o?d.featureTemplateSelectionRequired:d.featureTemplateSelection,children:(0,Q().getWorkflowTemplateName)(t)},t.templateId)}))})]}):null}var It=()=>o(857639),bt=()=>o(290966);function wt(e){const{transaction:t,collectionStore:o,action:n,logger:l}=e;"create"===n.type||"update"===n.type?(0,bt().ZQ)({transaction:t,collectionStore:o,templateId:n.templateId,instance:n.pointer,logger:l}):(0,H().HB)(n)}function xt(e){const{builderOutput:t}=e,{collectionStore:o}=ue(),l=(0,r().v3)(),[i,a]=(0,n.useState)(!1),s=(0,n.useCallback)((()=>{const e=V().A.state;if(!e)return void ge().D6({label:"Workflow templates are not loaded!"});(0,It().log)({level:"info",from:"WorkflowTemplatesBuilder.InstallTemplatesButton",type:"install",data:{miscDataToConvertToString:t}}),a(!0);const{serverCommitResult:n,performResult:{created:r,updated:i}}=$({environment:l,collectionInfo:e.collectionInfo,templateToRowIdMap:e.templateToRowIdMap,templates:t.templateOutputs.filter((e=>"unchanged"!==e.type)).map((e=>e.template))}),{serverCommitResult:s}=function(e){const{environment:t,collectionStore:o,actions:n}=e,l=new(Q().WorkflowTemplateLogger);return B().createAndCommit({userAction:"builderInstantiationActions.executeBuilderInstanceActions",environment:t,canUndo:!0,perform(e){for(const t of n)wt({transaction:e,collectionStore:o,action:t,logger:l})}})}({environment:l,actions:t.instanceActions,collectionStore:o});Promise.all([n,s]).then((()=>{ge().D6({label:`Created ${r} templates and updated ${i}.`})})).catch((e=>{console.error(e),ge().D6({label:"Alas, an error occurred. See the console for details."})})).finally((()=>{a(!1)}))}),[l,t,o]),{counts:c}=t;return(0,E.jsxs)(p().A,{size:"lg",onClick:s,disabled:i,children:["Install templates to prototype registry (",c.new," new,"," ",c.changed," changed)"]})}function Tt(e){let{children:t,style:o}=e;const n=(0,a().IS)((e=>({pre:{backgroundColor:e.modalBackground,fontSize:12,padding:10,overflow:"auto",...o}})),[o]);return(0,E.jsx)("pre",{style:n.pre,children:t})}const jt=n.memo(Tt);function kt(e){const t=(0,z().tz)(),{object:o}=e,n=(0,a().IS)((e=>({container:{position:"relative"},pre:{backgroundColor:e.modalBackground,padding:10,fontSize:12,overflow:"auto",maxHeight:"500px"},copyButton:{position:"absolute",top:10,right:10}})),[]);return(0,E.jsxs)("div",{style:n.container,children:[(0,E.jsx)(jt,{style:n.pre,children:JSON.stringify(o,null,2)}),(0,E.jsx)(it().A,{style:n.copyButton,icon:lt().n,ariaLabel:t.formatMessage({id:"workflowTemplatesBuilder.uidoc.jsonSnippet.copyButton",defaultMessage:"Copy to clipboard"}),onClick:()=>{navigator.clipboard.writeText(JSON.stringify(o,null,2))}})]})}function Ct(e){const{errors:t,label:o,type:n}=e;return(0,E.jsx)(St,{messages:t,label:o,type:n||"error"})}function St(e){const{messages:t,label:o,type:n}=e;return(0,E.jsxs)("div",{className:n,children:[o,(0,E.jsx)("ul",{children:t.map(((e,t)=>(0,E.jsx)("li",{children:e},t)))})]})}function Ot(e){var t;const{label:o,color:n,value:l,onChange:r}=e,{allIcons:i}=ue(),a=(null===(t=(0,Ce().DV)(l))||void 0===t?void 0:t.iconName)??"";return(0,E.jsxs)("div",{style:{display:"flex"},children:[(0,E.jsx)(u().OV,{label:o,value:a,onChange:e=>{r(`/icons/${e}_${n}.svg`)},options:i}),(0,E.jsx)("img",{src:l,style:{width:32,height:32},alt:a})]})}var Mt=o.n(o(702189)),_t=()=>o(859428),Bt=()=>o(357473);function Vt(e){const{oldValue:t,newValue:o}=e,n=new(Mt()),l=n.diff_linesToChars_(t,o),r=n.diff_main(l.chars1,l.chars2,!1);n.diff_charsToLines_(r,l.lineArray),n.diff_cleanupSemantic(r);const i=(0,a().IS)((e=>({container:{position:"relative"},pre:{backgroundColor:e.modalBackground,padding:10,fontSize:12,overflow:"auto",maxHeight:"500px"},copyButtons:{position:"absolute",display:"flex",flexDirection:"row",gap:4,top:10,right:10},copyButtonNewIcon:{stroke:e.stroke.greenSecondary},copyButtonOldIcon:{stroke:e.tint.uiRedHover},diffDelete:{backgroundColor:e.tint.uiRed,color:e.text.redPrimary,textDecoration:"line-through"},diffInsert:{backgroundColor:e.stroke.greenSecondary}})),[]),s=e=>{const l=()=>{if("diff"===e){const e=n.patch_make(t,o),l=n.patch_toText(e);navigator.clipboard.writeText(l)}else navigator.clipboard.writeText("new"===e?o:t);ge().D6({label:`Copied ${e} value to clipboard`})},r="new"===e?i.copyButtonNewIcon:"old"===e?i.copyButtonOldIcon:void 0,a=`Copy ${e} value to clipboard`;return(0,E.jsx)(_t().A,{placement:mt().W.Top,renderTooltip:()=>a,render:t=>(0,E.jsx)(pt().p,{...t,icon:lt().n,iconStyle:r,ariaLabel:a,onClick:l,children:e})})};return(0,E.jsxs)("div",{style:i.container,children:[(0,E.jsx)(jt,{style:i.pre,children:r.map(((e,t)=>{let o,n,[l,r]=e;return l===Bt().Cm?(o="diff-delete",n=i.diffDelete):l===Bt().Ug&&(o="diff-insert",n=i.diffInsert),(0,E.jsx)("span",{className:o,style:n,children:r},t)}))}),(0,E.jsxs)("div",{style:i.copyButtons,children:[s("diff"),s("old"),s("new")]})]})}function $t(e){var t;const{item:o,builderOutput:n}=e,l=ue(),{dispatch:r}=l,i=Ie({builderContext:l,item:o}),a=(0,ee().vO)(o),s=(0,ee().rW)(l,o),c="collection"===o.type?o.descriptionAsString:void 0,d=(0,te().O)(o);return(0,E.jsxs)("div",{children:["collection"!==o.type&&"compound"!==o.type&&"uninstantiated_template"!==o.type&&(0,E.jsx)(u().Vk,{label:"Do not instantiate a template for this primitive",value:s.ignore,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"ignore",value:e})}}),"uninstantiated_template"!==o.type&&"collection"!==o.type&&(0,E.jsx)(u().Vk,{label:"Map to existing template, do not update it",value:s.shouldMapToTemplate,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"shouldMapToTemplate",value:e})}}),!s.ignore&&(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(u().Pe,{label:"Template id",value:s.templateId??"",disabled:"uninstantiated_template"===o.type&&"mapToTemplateId"===i.type,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"templateId",value:e})}}),(0,E.jsx)(Dt,{action:i,builderOutput:n,onUndelete:()=>{r({type:"updateBuilderSettings",key:a,property:"isDeleted",value:!1})}})]}),l.state.createCopy&&(0,E.jsx)(u().Vk,{label:"Bypass create copy (allow reuse of original template)",value:s.bypassCreateCopy,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"bypassCreateCopy",value:e})}}),"createOrUpdateTemplate"===i.type&&(0,E.jsxs)(E.Fragment,{children:["compound"===o.type||"layout"===o.type?(0,E.jsx)(u().Pe,{label:"Name",value:s.name,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"name",value:e})}}):void 0,"compound"===o.type&&(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(Ot,{label:"Icon",color:"gray",value:s.icon,onChange:e=>r({type:"updateBuilderSettings",key:a,property:"icon",value:e})}),(0,E.jsxs)("ol",{children:[s.templateItems.map(((e,t)=>(0,E.jsxs)("li",{children:[(0,E.jsx)(Nt,{templateItem:e,onChange:e=>{var o,n,l;r({type:"updateBuilderSettings",key:a,property:"templateItems",value:(o=s.templateItems,n=e,l=t,o.map(((e,t)=>t===l?n:e)))})}}),(0,E.jsx)(p().A,{size:"lg",style:{marginBottom:4},onClick:()=>{var e,o;r({type:"updateBuilderSettings",key:a,property:"templateItems",value:(e=s.templateItems,o=t,e.filter(((e,t)=>t!==o)))})},children:"Delete compound template item"})]},t))),(0,E.jsx)("p",{children:(0,E.jsx)(p().A,{size:"lg",onClick:()=>{r({type:"updateBuilderSettings",key:a,property:"templateItems",value:[...s.templateItems,{pointer:void 0,optionality:"optionalDefaultOn"}]})},children:"Add compound template item"})}),(0,E.jsx)(Ft,{templateItems:s.templateItems,onChange:e=>r({type:"updateBuilderSettings",key:a,property:"templateItems",value:e})})]})]}),"property"!==o.type&&"collection_view"!==o.type&&(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(u().Pe,{label:"Description",value:s.description??"",placeholder:c,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"description",value:e})}}),c&&s.description&&s.description!==c?(0,E.jsx)("aside",{children:"Leave this blank to fall back to the underlying primitive's description."}):null]}),"property"===o.type&&"relation"===o.schema.type&&(0,E.jsx)(Rt,{label:"Related collection",value:s.relatedCollectionTemplateId,onChange:e=>r({type:"updateBuilderSettings",key:a,property:"relatedCollectionTemplateId",value:e})}),"collection"===o.type?(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(u().AW,{label:"Category",value:(0,ee().To)(s.category),onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"category",value:(0,ee().OU)(e)})},options:Se().RX}),null!==(t=o.format)&&void 0!==t&&t.item_name_config_v2?(0,E.jsx)("p",{children:"The collection specifies its own item name terminology. Cool, we will reuse that!"}):(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("p",{children:"The collection does not specify its own item name terminology. You can specify it below, but this is deprecated and support for it will be removed soon."}),(0,E.jsx)(u().Pe,{label:"Singular",value:s.singularItemName,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"singularItemName",value:e})}}),(0,E.jsx)(u().Pe,{label:"Plural",value:s.pluralItemName,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"pluralItemName",value:e})}})]}),(0,E.jsx)(u().Vk,{label:"Use minimal onboarding",value:s.hasMinimalOnboarding,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"hasMinimalOnboarding",value:e})}})]}):(0,E.jsxs)(E.Fragment,{children:["compound"!==o.type&&!d&&(0,E.jsx)(u().Vk,{label:"Include in collection template",value:s.includeInCollectionTemplate,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"includeInCollectionTemplate",value:e})}}),s.includeInCollectionTemplate&&!d&&(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(u().OV,{label:"Required",value:s.optionality,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"optionality",value:e})},options:Pt,optionLabels:Et}),"compound"!==o.type&&(0,E.jsx)(u().Vk,{onChange:e=>r({type:"updateBuilderSettings",key:a,property:"isInSettings",value:e}),label:"Is pulled up to top of customize menu",value:s.isInSettings})]})]}),"property"===o.type&&Me(o.schema)&&(0,E.jsx)(u().OV,{label:"Property options type",value:s.propertyOptionsType,onChange:e=>{r({type:"updateBuilderSettings",key:a,property:"propertyOptionsType",value:e})},options:["sample","content"]})]}),("createOrUpdateTemplate"===i.type||"mapToTemplateId"===i.type)&&("compound"===o.type||"uninstantiated_template"===o.type)&&(0,E.jsx)(p().A,{size:"lg",onClick:()=>r({type:"updateBuilderSettings",key:a,property:"isDeleted",value:!0}),children:"Delete"})]})}function Nt(e){const{templateItem:t,onChange:o}=e;return(0,E.jsxs)("div",{children:[(0,E.jsx)(At,{excludeTypes:["collection","compound"],value:t.pointer,onChange:e=>o({...t,pointer:e})}),(0,E.jsx)(u().OV,{label:"Required",value:t.optionality,onChange:e=>o({...t,optionality:e}),options:Pt,optionLabels:Et})]})}function Rt(e){const{label:t,value:o,onChange:l}=e,r=ue(),{options:i,optionLabels:a}=(0,n.useMemo)((()=>{const e=[Ue],t={[Ue]:"(self-relation)"};for(const o of r.templateRegistryMap.values())"collection"===o.type&&(e.push(o.templateId),t[o.templateId]=`${o.value.targetCollection.name} (${o.templateId})`);return{options:e,optionLabels:t}}),[r.templateRegistryMap]);return(0,E.jsx)(u().AW,{label:t,value:o,onChange:l,options:i,optionLabels:a})}function At(e){const t=ue(),{value:o,onChange:n,excludeTypes:l}=e,r=new Set(l),i={},a=[];for(const[s,p]of t.featureInfoMap.entries())r.has(p.type)||(a.push(s),i[s]=(0,ee().D6)(t,p));return(0,E.jsx)(u().AW,{label:"Template",value:o,onChange:n,options:a,optionLabels:i})}function Dt(e){const{action:t,builderOutput:o,onUndelete:n}=e,l=(0,a().IS)((e=>({success:{color:e.stroke.greenPrimary},subtle:{color:e.text.graySecondary}})),[]);switch(t.type){case"mapToTemplateId":return(0,E.jsxs)("aside",{children:["This will be mapped to the"," ",(0,E.jsx)(et,{children:t.templateId})," template."]});case"createOrUpdateTemplate":const e=o.templateOutputs.find((e=>e.template.templateId===t.templateId));if(!e)return(0,E.jsx)("aside",{className:"error",children:"An error occurred when generating the new template."});switch(e.type){case"new":return(0,E.jsxs)(tt,{children:[(0,E.jsx)("summary",{style:l.success,children:"A new template will be created."}),(0,E.jsx)("p",{children:"Here's the new template's JSON:"}),(0,E.jsx)(Vt,{oldValue:"",newValue:JSON.stringify(e.template,null,2)})]});case"unchanged":return(0,E.jsxs)(tt,{type:"superSubtle",children:[(0,E.jsx)("summary",{style:l.subtle,children:"This template has not been changed from its value in the registry."}),(0,E.jsx)("p",{children:"Here's the unchanged template's JSON:"}),(0,E.jsx)(Vt,{oldValue:JSON.stringify(e.template,null,2),newValue:JSON.stringify(e.template,null,2)})]});case"changed":return(0,E.jsxs)(tt,{children:[(0,E.jsxs)("summary",{style:l.success,children:["The existing template will be updated to version"," ",e.newVersion," (however, instances of the template will not be updated)."]}),(0,E.jsxs)("div",{children:[(0,E.jsx)("p",{children:"The following changes will be made to the template in the registry:"}),(0,E.jsx)(Vt,{oldValue:e.originalTemplateJson,newValue:e.templateJson})]})]})}(0,H().HB)(e);break;case"ignore":return"deleted"===t.reason?(0,E.jsxs)("aside",{children:["This has been deleted and won't be included in any templates."," ",(0,E.jsx)(p().A,{size:"lg",onClick:n,children:"Undelete"})]}):(0,E.jsxs)("aside",{children:["This data will be ignored (reason:"," ",(0,E.jsx)(et,{children:t.reason}),")."]});case"invalidCopyName":return(0,E.jsx)("aside",{className:"error",children:"This id is already taken."})}}function Ft(e){const{templateItems:t,onChange:o}=e,n=ue();return t.length<=1?null:(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("aside",{children:"Drag-and-drop in the list below to re-order template items."}),(0,E.jsx)(ve().Ay,{direction:"vertical",keys:t.map(((e,t)=>t.toString())),renderKey:e=>{const o=t[parseInt(e)].pointer,l=o?(0,ee().D6)(n,o):"(ERROR)";return(0,E.jsx)(nt,{children:l})},onDrop:e=>{o(e.map((e=>t[parseInt(e)])))}})]})}const Pt=["required","optionalDefaultOn","optionalDefaultOff"],Et={optionalDefaultOn:"Optional (default on)",optionalDefaultOff:"Optional (default off)",required:"Required"};function Lt(e){const{builderContextState:t,...o}=e,n=(0,a().IS)((e=>({error:{color:e.text.redSecondary}})),[]);switch(t.type){case"loaded":return(0,E.jsx)(de.Provider,{value:t.context,children:(0,E.jsx)(Wt,{...o})});case"emptyInput":return null;case"error":return(0,E.jsx)("div",{style:n.error,children:t.message});case"loading":return(0,E.jsxs)("p",{children:[(0,E.jsxs)("strong",{children:[t.message||"Loading","…"]}),(0,E.jsx)("br",{}),"collection view block id:"," ",(0,E.jsx)(et,{children:t.collectionViewBlockId||"(unknown)"}),(0,E.jsx)("br",{}),"collection id:"," ",(0,E.jsx)(et,{children:t.collectionId||"(unknown)"})]})}(0,H().HB)(t)}function Wt(e){var t;const{isCompact:o}=e,l=ue(),r=(0,i().K8)((()=>qe(l)),[l]),a=(0,n.useMemo)((()=>l.featureOrdering.filter((e=>{const t=l.featureInfoMap.get(e);if(t){const e=Ie({builderContext:l,item:t});return("createOrUpdateTemplate"===e.type||"mapToTemplateId"===e.type)&&e.includeInCollectionTemplate}return!1}))),[l]),s=(0,i().K8)((()=>null!==V().A.state),[]),p=F(),d=r.warnings.length>0?(0,E.jsx)(Ct,{errors:r.warnings,type:"warning",label:"Your templates have the following warnings. While you can save them to the registry, we won't be able to ship them to production until they're fixed:"}):null,u=r.hasNewOrChangedTemplates?(0,E.jsx)(xt,{builderOutput:r}):(0,E.jsx)("aside",{children:"The template registry is up to date."}),{properties:m,collectionViews:f,compoundTemplateInfos:y,blockTemplateInfos:h,automationInfos:g,uninstantiatedTemplateInfos:v}=(0,n.useMemo)((()=>{const e=[],t=[],o=[],n=[],r=[],i=[];for(const a of l.featureOrdering){const s=l.featureInfoMap.get(a);if(s)switch(s.type){case"property":e.push(s);break;case"collection_view":t.push(s);break;case"compound":o.push(s);break;case"uninstantiated_template":i.push(s);break;case"collection":case"layout":break;case"block":n.push(s);break;case"automation":r.push(s);break;default:(0,H().HB)(s)}}return{properties:e,collectionViews:t,compoundTemplateInfos:o,blockTemplateInfos:n,automationInfos:r,uninstantiatedTemplateInfos:i}}),[l.featureInfoMap,l.featureOrdering]),I=Boolean(0===r.errors.length&&s&&p);let b=null,w=r.warnings.length;const x=null===(t=l.sourceCollectionTemplate)||void 0===t||null===(t=t.builderMetadata)||void 0===t?void 0:t.sourceCollectionViewBlock;x&&!l.isOriginalSourceCollectionViewBlock&&(b=(0,E.jsxs)("p",{className:"warning",children:["The template you're updating was created based on"," ",(0,E.jsx)("a",{href:(0,he().Jj)(x),children:"this collection"}),", which is different from the one you provided."]}),w+=1);const T=(0,n.useMemo)((()=>Ze(r,l)),[l,r]),j=(0,E.jsxs)(E.Fragment,{children:[b,(0,E.jsx)(Kt,{sourceCollectionViewBlockURL:(0,he().Jj)(l.sourceCollectionViewBlockPointer),collectionInfo:l.collectionInfo,properties:m,collectionViews:f,builderOutput:r}),(0,E.jsx)(zt,{blockTemplateInfos:h,pageTemplatesErrors:l.pageTemplatesErrors,builderOutput:r}),(0,E.jsx)(Jt,{automationInfos:g,automationErrors:l.automationErrors,builderOutput:r}),(0,E.jsx)(qt,{compoundTemplateInfos:y,builderOutput:r}),(0,E.jsx)(Ut,{uninstantiatedFeatures:v,builderOutput:r}),(0,E.jsxs)("div",{style:{display:"flex",flexDirection:"row",gap:30},children:[(0,E.jsx)(Ht,{featureOrdering:a,onChange:e=>l.dispatch({type:"setFeatureOrdering",featureOrdering:e})}),T&&(0,E.jsx)(vt,{builderOutputWorld:T})]}),(0,E.jsx)(c().iK,{children:"Output"}),r.errors.length>0&&(0,E.jsx)(Ct,{errors:r.errors,label:"You can't save the templates to the registry until the following errors are fixed:"}),r.debugMessages.length>0&&(0,E.jsxs)(tt,{type:"subtle",children:[(0,E.jsx)("summary",{children:"Debug log"}),(0,E.jsx)(St,{messages:r.debugMessages})]}),I&&(0,E.jsxs)(E.Fragment,{children:[d,u]}),(0,E.jsxs)(tt,{children:[(0,E.jsx)("summary",{children:"Template definition JSON output"}),(0,E.jsx)(kt,{object:r.templateOutputs.map((e=>e.template))})]}),r.fakeLocalizedTemplates&&(0,E.jsxs)(tt,{children:[(0,E.jsx)("summary",{children:"Fake-localized template definition JSON output"}),(0,E.jsx)(kt,{object:r.fakeLocalizedTemplates})]}),(0,E.jsxs)(tt,{children:[(0,E.jsx)("summary",{children:"Template instance actions JSON output"}),(0,E.jsx)(kt,{object:r.instanceActions})]})]});if(o){const e=r.errors.length>0?(0,E.jsxs)("span",{className:"error",children:[r.errors.length," errors"]}):null,t=w>0?(0,E.jsxs)("span",{className:"warning",children:[w," warnings"]}):null,o=(0,E.jsxs)("span",{children:[r.counts.new," new, ",r.counts.changed," changed"]});return(0,E.jsxs)(tt,{style:{margin:0},children:[(0,E.jsxs)("summary",{style:{display:"flex",flexDirection:"row",alignItems:"center"},children:[(0,E.jsxs)("div",{style:{flexGrow:1},children:[l.collectionInfo.name," - ",e," ",t," ",o]}),(0,E.jsx)("div",{children:I&&u})]}),j]})}return j}function Kt(e){const{sourceCollectionViewBlockURL:t,collectionInfo:o,properties:n,collectionViews:l,builderOutput:r}=e;return(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("h2",{children:"Collection"}),(0,E.jsxs)("p",{children:["This is the"," ",(0,E.jsx)("strong",{children:(0,E.jsx)(st,{href:t,openInNewTab:!0,children:o.name})})," ","collection."]}),(0,E.jsx)(Gt,{}),(0,E.jsx)($t,{item:o,builderOutput:r}),(0,E.jsx)("h2",{children:"Properties"}),(0,E.jsx)("ul",{children:n.map((e=>{const{id:t,schema:o}=e;return(0,E.jsxs)("li",{children:[(0,E.jsx)("div",{children:(0,E.jsx)("strong",{children:o.name})}),e.isSupported?(0,E.jsx)($t,{item:e,builderOutput:r}):(0,E.jsxs)("div",{className:"error",children:["Alas, the ",(0,E.jsx)(et,{children:o.type})," ","property type is not currently supported by the builder."]})]},t)}))}),(0,E.jsx)("h2",{children:"Views"}),(0,E.jsx)("ul",{children:l.map((e=>(0,E.jsxs)("li",{children:[(0,E.jsx)("div",{children:(0,E.jsx)("strong",{children:e.name})}),(0,E.jsx)($t,{item:e,builderOutput:r})]},e.id)))}),o.layout&&(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("h2",{children:"Layout"}),(0,E.jsx)($t,{item:o.layout,builderOutput:r})]})]})}function Ut(e){const{uninstantiatedFeatures:t,builderOutput:o}=e;return 0===t.length?null:(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("h2",{children:"Uninstantiated templates"}),(0,E.jsx)("ul",{children:t.map((e=>(0,E.jsx)("li",{children:(0,E.jsx)($t,{item:e,builderOutput:o})},e.id)))})]})}function qt(e){const{compoundTemplateInfos:t,builderOutput:o}=e,{dispatch:n}=ue();return(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("h2",{children:"Compound templates"}),(0,E.jsx)("ul",{children:t.map((e=>(0,E.jsx)("li",{children:(0,E.jsx)($t,{item:e,builderOutput:o})},e.id)))}),(0,E.jsx)("p",{children:(0,E.jsx)(p().A,{size:"lg",onClick:()=>{const e=window.prompt("Enter a name for the new compound template (it can be changed later).");e&&n({type:"addNewCompoundTemplate",initialName:e})},children:"Add new compound template…"})})]})}function Jt(e){const{automationInfos:t,automationErrors:o,builderOutput:n}=e;return(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("h2",{children:"Automations"}),o.length>0&&(0,E.jsx)("div",{className:"error",children:(0,E.jsx)("ul",{children:o.map(((e,t)=>(0,E.jsx)("li",{children:e},t)))})}),(0,E.jsx)("ul",{children:t.map((e=>(0,E.jsxs)("li",{children:[(0,E.jsx)("div",{children:(0,E.jsx)("strong",{children:e.name})}),(0,E.jsx)($t,{item:e,builderOutput:n})]},e.id)))})]})}function zt(e){const{blockTemplateInfos:t,pageTemplatesErrors:o,builderOutput:n}=e;return(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("h2",{children:"Page Templates"}),o.length>0&&(0,E.jsx)("div",{className:"error",children:(0,E.jsx)("ul",{children:o.map(((e,t)=>(0,E.jsx)("li",{children:e},t)))})}),(0,E.jsx)("ul",{children:t.map((e=>(0,E.jsxs)("li",{children:[(0,E.jsx)("div",{children:(0,E.jsx)("strong",{children:e.name})}),(0,E.jsx)($t,{item:e,builderOutput:n})]},e.id)))})]})}function Ht(e){const{featureOrdering:t,onChange:o}=e,n=ue(),l=(0,i().K8)((()=>Ze(qe(n),n)),[n]),r=(0,i().K8)((()=>{const e=[];for(const o of t){const t=n.featureInfoMap.get(o);"property"!==(null==t?void 0:t.type)&&"compound"!==(null==t?void 0:t.type)||e.push(o)}return e}),[n.featureInfoMap,t]),a=(0,i().K8)((()=>{const e=[];for(const o of t){const t=n.featureInfoMap.get(o);"collection_view"===(null==t?void 0:t.type)&&e.push(o)}return e}),[n.featureInfoMap,t]),s=(0,i().K8)((()=>{const e=[];for(const o of t){const t=n.featureInfoMap.get(o);"collection_view"!==(null==t?void 0:t.type)&&"property"!==(null==t?void 0:t.type)&&"compound"!==(null==t?void 0:t.type)&&e.push(o)}return e}),[n.featureInfoMap,t]),p=e=>{o([...e,...a,...s])},d=()=>{ge().D6({label:"Reorder views by editing the collection itself, instead of through the builder."})},u=e=>{o([...r,...a,...e])};if(t.length<=1)return null;const m=e=>{const t="Properties"===e?r:"Views"===e?a:s;return 0===t.length?null:(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("p",{children:e}),(0,E.jsx)(ve().Ay,{direction:"vertical",keys:t,renderKey:t=>(0,E.jsx)(nt,{children:(0,E.jsx)(ht,{builderContext:n,builderOutputWorld:l,builderKey:t,showType:t=>!("property"===t&&"Properties"===e||"collection_view"===t&&"Views"===e)})}),onDrop:"Properties"===e?p:"Views"===e?d:u})]})};return(0,E.jsxs)("div",{children:[(0,E.jsx)(c().iK,{children:"Feature ordering"}),(0,E.jsx)("aside",{children:"Drag-and-drop in the list below to re-order the collection features."}),m("Properties"),m("Views"),m("Other")]})}function Gt(){const{state:e,dispatch:t,collectionInfo:o}=ue(),l=Boolean(o.templateId);return(0,n.useEffect)((()=>{!l&&e.createCopy&&t({type:"setCreateCopy",createCopy:!1})}),[l,t,e.createCopy]),l?(0,E.jsx)("div",{className:"paragraph",children:(0,E.jsx)(u().Vk,{onChange:e=>t({type:"setCreateCopy",createCopy:e}),label:`Create a copy of the source "${o.templateId}" template (instead of updating it)`,value:e.createCopy})}):null}const Xt="workflowTemplateBuilderState",Yt=new URLSearchParams(window.location.search.slice(1)),Qt="initialUrl",Zt="initialMultiCollectionPageUrl";Yt.get(Qt),Yt.get(Zt);function eo(){if(!(0,l().X)("workflow_templates_builder"))throw new Error("Assertion failure, builder is not enabled!");const e=Boolean(F()),t=function(){const e=(0,r().v3)(),[t]=(0,y().Yb)((async()=>{const t=await(0,X().default)({environment:e,url:"/icons/all",method:"GET",format:"json",mode:"cors"});if("success"===t.type){const e=null==t?void 0:t.data;return Object.keys(e)}}),[e]);return(null==t?void 0:t.value)??[]}(),o=(0,r().v3)(),n=(0,i().O$)(o.RouterStore).route,p=(0,a().IS)((e=>({container:{backgroundColor:e.contentBackground,borderRadius:6,borderBottom:`1px solid ${e.stroke.graySecondary}`,borderTop:`1px solid ${e.stroke.graySecondary}`}})),[]);let c;if("page"===n.name&&n.blockId&&n.collectionViewId&&e){const e=`${d().A.domainBaseUrl}/${(0,s().Xw)(n.blockId)}`;c=(0,E.jsx)(to,{url:e,allIcons:t,hideUntilLoaded:!0,showOnlyIfOriginalSourceCollection:!0,className:"uidoc-workflow-templates-builder-in-app",style:p.container},e)}return(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(L,{}),c]})}function to(e){const{url:t,allIcons:o,hideUntilLoaded:l,showOnlyIfOriginalSourceCollection:r,className:i,style:a}=e,s=(0,n.useMemo)((()=>({...U,url:t})),[t]),[p,c]=m(`${Xt}_${t}`,K,s),d=me({state:p,dispatch:c,allIcons:o,requireTemplateInstance:!0,...ye()});if(l&&"loaded"!==d.type)return null;if(r&&"loaded"===d.type&&!d.context.isOriginalSourceCollectionViewBlock)return null;const u=(0,E.jsx)(Lt,{builderContextState:d,isCompact:!0});return i||a?(0,E.jsx)("div",{className:i,style:a,children:u}):u}function oo(e){return(0,l().X)("workflow_templates_builder")?(0,E.jsx)(eo,{}):null}},264760:(e,t,o)=>{o.d(t,{AW:()=>d,OV:()=>p,Pe:()=>u,Vk:()=>s});o(581454);var n=o(296540),l=()=>o(401497),r=()=>o(498212),i=o(474848);const a={marginBottom:4};function s(e){const{label:t,value:o,onChange:n}=e,l=m();return(0,i.jsxs)("div",{style:a,children:[(0,i.jsx)("input",{type:"checkbox",checked:o,id:l,onChange:e=>n(e.target.checked)}),(0,i.jsx)("label",{htmlFor:l,children:t})]})}function p(e){const{label:t,value:o,onChange:n,options:r,optionLabels:s}=e,p=m(),c=(0,l().IS)((e=>({container:a,select:{display:"inline-flex",alignItems:"center",justifyContent:"space-between",backgroundColor:"transparent",borderRadius:6,border:`1px solid ${e.outlineButtonBorder}`}})),[]);return(0,i.jsxs)("div",{style:c.container,children:[(0,i.jsxs)("label",{htmlFor:p,children:[t,": "]}),(0,i.jsx)("select",{value:o,onChange:e=>n(e.target.value),style:c.select,children:r.map((e=>(0,i.jsx)("option",{value:e,children:s?s[e]:e},e)))})]})}const c="(none)";function d(e){const{label:t,value:o,onChange:n,options:l,optionLabels:r}=e;return(0,i.jsx)(p,{label:t,value:o??c,onChange:e=>n(e===c?void 0:e),options:[c,...l],optionLabels:r?{...r,[c]:"none"}:void 0})}function u(e){const{label:t,value:o,onChange:n,placeholder:r,dataList:s,disabled:p}=e,c=m(),d=m(),u=(0,l().IS)((e=>({input:{fontSize:14,lineHeight:"20px",position:"relative",borderRadius:6,boxShadow:e.inputBoxShadow,background:e.inputBackground,cursor:"text",paddingTop:4,paddingBottom:4,paddingLeft:10,paddingRight:10,border:"unset"}})),[]);return(0,i.jsxs)("div",{style:a,children:[(0,i.jsxs)("label",{htmlFor:c,children:[t,": "]}),(0,i.jsx)("input",{style:u.input,id:c,list:s?d:void 0,type:"text",value:o,disabled:p,placeholder:r,onChange:e=>{n(e.target.value)}}),s&&(0,i.jsx)("datalist",{id:d,children:s.map(((e,t)=>(0,i.jsx)("option",{value:e},t)))})]})}function m(){const[e]=(0,n.useState)((()=>(0,r().Ay)()));return e}},299177:(e,t,o)=>{o.d(t,{A:()=>r});class n extends(()=>o(757695))().default{getInitialState(){return{}}}const l=new n;o(604341).exposeDebugValue("SpaceWorkflowTemplateInstanceMapStore",l);const r=l},425981:(e,t,o)=>{o.d(t,{C:()=>l});var n=()=>o(941541);class l{constructor(e,t,o){this.listener=void 0,this.didEmit=void 0,this.lastValue=void 0,this.handleEmit=(e,t,o)=>{let n=!0;this.didEmit||(this.didEmit=!0,n=!1),this.lastValue===t?n=!1:this.lastValue=t,n&&this.onEmit(t,o)},this.environment=e,this.listenerEventKey=t,this.onEmit=o,this.didEmit=!1,this.lastValue=void 0}subscribe(){this.listener=n().Ay.addListener(this.listenerEventKey,void 0,this.handleEmit,void 0,this.environment)}unsubscribe(){this.listener&&n().Ay.removeListener(this.listener,this.environment)}}},888325:(e,t,o)=>{function n(e){return`${e.table}:${e.id}`}o.d(t,{_:()=>n})},966759:(e,t,o)=>{o.d(t,{i:()=>r});var n=()=>o(476492),l=()=>o(175213);function r(e){const{environment:t,collectionContextStore:o,property_type:r,from:i,property:a,...s}=e,p=(0,n().sl)(o)||{};(0,l().G)(t,{property:a,property_type:r,from:i,...s,...p})}}}]);