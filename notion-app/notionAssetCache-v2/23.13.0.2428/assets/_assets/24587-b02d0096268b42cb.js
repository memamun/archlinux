"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[24587],{301782:(t,e,o)=>{o.d(e,{CM:()=>m,UB:()=>d,zc:()=>l});o(898992),o(354520),o(581454);var n=()=>o(890409),a=()=>o(973647),i=()=>o(534177),r=()=>o(862292),c=()=>o(989423),s=()=>o(909470),u=()=>o(546461);function l(t){const{automationActionStore:e,automationStore:o,formulaAnalyticsModule:r,formulasModule:c,simpleFormulasModule:l}=t,d=e.getModel(),m=o??e.getParentStore();if(!d||!m)return;const p=m.getActionStores().map((t=>t.getModel())).filter(i().O9),f=(0,u().To)(m);let g=[];return f&&a().Q.isSuccess(f)&&(g=f.value.valueTypes),(0,n()._f)({automationActionModel:d,automationActionModels:p,formulaAnalyticsModule:r,formulasModule:c,simpleFormulasModule:l,formulaTypecheckContextValues:g,getRecordModel:e.getRecordModel,featureGates:(0,s().i)()})}function d(t,e){const{automationStore:o,automationActionStore:n}=e;o.isTriggerType("event")||m(((e,a,i)=>{const r=l({automationActionStore:n,automationStore:o,formulaAnalyticsModule:a,formulasModule:e,simpleFormulasModule:i});r&&(0,c().pM)(t,"automation_action_update",n.id,1,{automation_action:r,automation_action_id:n.id,automation_id:o.id})}))}function m(t){return Promise.all([r().T.formulas.load(),r().T.formulaAnalytics.load(),r().T.simpleFormulas.load()]).then((e=>{let[o,n,a]=e;t(o,n,a)})).catch((t=>{console.error("Error sending analytics for automations",t)}))}},324587:(t,e,o)=>{o.r(e),o.d(e,{addAutomationAction:()=>W,clearInvalidVariables:()=>$,createAutomation:()=>z,deleteAutomation:()=>j,disableAutomation:()=>Y,duplicateAutomation:()=>U,duplicateAutomationAction:()=>Q,enableAutomation:()=>q,insertEmptyTextInDuplicateBlockAction:()=>L,messages:()=>V,removeAutomationAction:()=>Z,reorderAutomationActions:()=>K,restartAutomation:()=>D});o(16280),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520),o(672577),o(803949),o(581454);var n=o.n(o(794148)),a=()=>o(244641),i=()=>o(908006),r=()=>o(422540),c=()=>o(890409),s=()=>o(192845),u=()=>o(390527),l=()=>o(925551),d=()=>o(247331),m=()=>o(134025),p=()=>o(696706),f=()=>o(912720),g=()=>o(199378),v=()=>o(161479),y=()=>o(919709),M=()=>o(496603),S=()=>o(183558),A=()=>o(973647),_=()=>o(534177),C=()=>o(722101),h=()=>o(44729),T=()=>o(246826),b=()=>o(725614),I=()=>o(317909),k=()=>o(780054),R=()=>o(71584),w=()=>o(989423),x=()=>o(909470),P=()=>o(594794),B=()=>o(695625),O=()=>o(546461),F=()=>o(301782),E=()=>o(770586),N=()=>o(190019);const V=(0,o(959013).YK)({genericErrorMessage:{id:"automations.buttonTrigger.genericErrorMessage",defaultMessage:"Button failed to execute"},open:{defaultMessage:"Open",id:"automations.buttonTrigger.open"},undo:{defaultMessage:"Undo",id:"automations.buttonTrigger.undo"},defaultConfirmationWorkflowText:{defaultMessage:"Are you sure you want to continue?",id:"automations.buttonTrigger.defaultConfirmationWorkflowText"},defaultContinueWorkflowMessage:{defaultMessage:"Continue",id:"automations.buttonTrigger.defaultContinueWorkflowMessage"},defaultStopWorkflowMessage:{defaultMessage:"Cancel",id:"automations.buttonTrigger.defaultStopWorkflowMessage"},errorQueryCollectionTooManyPages:{defaultMessage:"Button impacts too many pages",id:"automations.buttonTrigger.errorQueryCollectionTooManyPages"},errorRecordInTrash:{id:"automations.buttonTrigger.errorRecordInTrash",defaultMessage:"Button is editing a page in trash"}});function z(t){const{actionIds:e,automationId:o,automationName:a,environment:i,inMemoryRecordCache:r,parentPointer:c,transaction:s,trigger:u}=t,l=o??(0,P().Z1)({environment:i,table:f().yB,spaceId:c.spaceId}),d=T().eC({environment:i,inMemoryRecordCache:r??i.defaultRecordCache.inMemoryRecordCache,table:f().yB,transaction:s,value:{action_ids:e,alive:!0,id:l,parent_id:c.id,parent_table:c.table,properties:{name:a},space_id:c.spaceId,status:"active",trigger:u}});return n()(d.isTriggerType(u.type),"Trigger type mismatch"),d}function W(t){const{actionId:e,environment:o,intl:a,automationStore:r,actionType:s,transaction:u,insertionPoint:l,config:d,createDuplicateBlocksContainer:m=!0,builderType:v="sidebar"}=t,M=r.getSpaceId();if(!M)return;let A;if("duplicate_blocks"===s&&m){A=T().Wv({environment:o,inMemoryRecordCache:r.inMemoryRecordCache,transaction:u,type:"text"});const t=L({environment:o,contentStore:A.getContentStore(),transaction:u});i().default.afterNextFlush((()=>{const e=B().T.find((e=>p().L3.isEqual(e.props.store.pointer,t.pointer)));e&&b().setSelectionAtStart({store:e.props.store.getBlockTitleStore()})}))}const h=d??function(t){const{actionType:e,automationStore:o,intl:n}=t;if("modal_confirmation"===e)return{continue_button:{text:n.formatMessage(V.defaultContinueWorkflowMessage)},cancel_button:{text:n.formatMessage(V.defaultStopWorkflowMessage)},text:{type:"simple",value:(0,y().x9d)(n.formatMessage(V.defaultConfirmationWorkflowText))}};if("define_variables"===e){const t=(0,S().Ay)();return{values:{[t]:{name:(0,E().v)(o.getActionStores(),n.formatMessage(g().xC)),value:{type:"simple",value:[[""]]}}},variableIds:[t]}}}({actionType:s,automationStore:r,intl:a})??{},I=T().eC({environment:o,inMemoryRecordCache:r.inMemoryRecordCache,table:g().SC,transaction:u,value:{id:e,type:s,parent_id:r.id,parent_table:f().yB,alive:!0,space_id:M,config:h,blocks:A?[A.id]:[]}});return A&&C().BC({transaction:u,parentStore:I.getKeyStore("blocks"),appendStore:A}),!l||"afterActionId"in l?C().BC({transaction:u,parentStore:r.getActionIdsStore(),appendStore:I,after:null==l?void 0:l.afterActionId}):"beforeActionId"in l?C().Hs({transaction:u,parentStore:r.getActionIdsStore(),prependStore:I,before:l.beforeActionId}):(0,_().HB)(l),G({transaction:u,automationStore:r}),(0,F().CM)(((t,e,n)=>{const a=(0,w().ik)(o),i=(0,F().zc)({automationActionStore:I,formulaAnalyticsModule:e,formulasModule:t,simpleFormulasModule:n});(0,_().O9)(i)&&(0,c().dW)(a,{automation_action:i,automation_action_id:I.id,automation_id:I.getParentId(),builder_type:v}),I.isDefined()&&(0,c().c_)(a,{automation_action_id:I.id,automation_action_type:I.getType(),automation_id:r.id,builder_type:v})})),n()(I.isType(s),"Action type mismatch"),I}function D(t){var e,o;const{automationStore:n,transaction:i}=t,r=n.getRecurrence();if(!r)return;const c=a().c9.now().plus({day:1}).startOf("day"),s={...r,start_date:c.toMillis(),end_condition:"date"===(null===(e=r.end_condition)||void 0===e?void 0:e.type)?{type:"date",end_at:(0,u().getNewEndTimestamp)(c,r.start_date,null===(o=r.end_condition)||void 0===o?void 0:o.end_at).toMillis()}:r.end_condition};T().zv({store:n,transaction:i,data:{status:"active"}}),T().zv({store:n.getKeyStore("trigger"),transaction:i,data:{recurrence:(0,u().convertFromUnpersistedRecurrenceConfig)(s)}})}function U(t){const{actorPointer:e,environment:o,includeParenting:n,sourceAutomationStore:a,targetAutomationId:i,transaction:r}=t,c=a.getParentStore();if(!c||!c.isReady())throw new Error("Automation parent store not ready");const s=a.getValue(),u=a.getSpaceId();if(!(0,_().O9)(s)||!(0,_().O9)(u))throw new Error("Undefined automation value or space id");const d={},m={...(0,M().mg)(s),id:i??(0,P().Z1)({environment:o,table:f().yB,spaceId:(0,v().e)(u)})};d[a.id]=m.id,(0,_().O9)(m.action_ids)&&(0,_().EI)(m.action_ids)&&m.action_ids.forEach((t=>d[t]=(0,P().Z1)({environment:o,table:g().SC,spaceId:(0,v().e)(u)})));const p=t=>{let{requested:e}=t;const o=d[e.id];return(0,_().O9)(o)?{...e,id:o}:e};(0,l().iN)({actor:e,duplicateRecord:m,options:{},mapper:p,originalRecord:s});const y=T().eC({environment:o,inMemoryRecordCache:a.inMemoryRecordCache,table:f().yB,transaction:r,value:m});n&&h().NI({childStore:y,parentStore:c,transaction:r});const S=a.getActionStores(),A=Promise.all(S.map((t=>{const e=d[t.id],{automationActionStore:n,onComplete:a}=Q({environment:o,includeParenting:!1,mapper:p,sourceActionStore:t,targetAutomationActionId:e,transaction:r});return h().NI({childStore:n,parentStore:y,transaction:r}),a}))),C=A.then((t=>t.flat()));return{automationStore:y,onComplete:C}}function Q(t){const{environment:e,includeParenting:o,insertionPoint:n,mapper:a,sourceActionStore:i,targetAutomationActionId:r,transaction:s}=t,u=i.getParentStore();if(!u||!u.isReady())throw new Error("Automation store is not ready");const d=i.getValue(),m=i.getSpaceId();if(!(0,_().O9)(d)||!(0,_().O9)(m))throw new Error("Undefined action value or space id");const p={...(0,M().mg)(d),id:r??(0,P().Z1)({environment:e,table:g().SC,spaceId:(0,v().e)(m)})},f=e.currentUser.id,y=i.inMemoryRecordCache.makeGetRecordRoleFn(f);(0,l().IH)({duplicateRecord:p,getRecordRole:y,originalRecord:d,mapper:t=>(null==a?void 0:a(t))??t.requested,options:{},originOptions:{baseUrl:k().A.domainBaseUrl,publicDomainName:k().A.publicDomainName},duplicateBlocks:!1});const S=T().eC({environment:e,inMemoryRecordCache:i.inMemoryRecordCache,table:g().SC,transaction:s,value:p});o&&(!n||"afterActionId"in n?h().NI({after:null==n?void 0:n.afterActionId,childStore:S,parentStore:u,transaction:s}):"beforeActionId"in n?h().Ti({before:null==n?void 0:n.beforeActionId,childStore:S,parentStore:u,transaction:s}):(0,_().HB)(n),G({transaction:s,automationStore:u}));const A=Promise.all(i.getBlockStores().map((t=>{const[o,n]=R().duplicateBlock({addCopyName:!1,baseUrl:k().A.domainBaseUrl,deepCopyTransclusionContainers:!1,environment:e,preferDuplicateLocation:"local",publicDomainName:k().A.publicDomainName,resolveTemplateVariables:!1,stores:[t],targetSpaceId:(0,v().e)(t.pointer.spaceId),transaction:s}),a=o[0];return h().NI({childStore:a,parentStore:S,transaction:s}),n}))),C=S.getModel();return(0,_().O9)(C)&&(0,F().CM)(((t,o,n)=>{const a=(0,w().ik)(e),i=(0,F().zc)({automationActionStore:S,formulaAnalyticsModule:o,formulasModule:t,simpleFormulasModule:n});(0,_().O9)(i)&&(0,c().dW)(a,{automation_action:i,automation_action_id:C.id,automation_id:C.parent_id,from:"duplicate"}),(0,c().c_)(a,{automation_action_id:C.id,automation_action_type:C.type,automation_id:u.id,from:"duplicate"})})),{automationActionStore:S,onComplete:A}}function K(t){const{environment:e,automationStore:o,automationTypecheckModule:n,contextType:a,formulasModule:i,intl:r,newActionIds:c,transaction:s,from:u,movedActionId:l}=t;T().zv({store:o,transaction:s,data:{action_ids:c}}),G({automationStore:o,transaction:s});H({automationStore:o,transaction:s,typecheckResult:(0,N().Z)({environment:e,automationStore:o,automationTypecheckModule:n,contextType:a,formulasModule:i,intl:r})}),(0,w().u4)({environment:e,event:{eventName:"automation_action_move",eventProperties:{automation_id:o.id,automation_action_id:l,from:u}}})}function Z(t){const{actionStore:e,automationStore:o,automationTypecheckModule:n,contextType:a,environment:i,formulasModule:r,intl:s,transaction:u}=t,l=(0,N().Z)({environment:i,automationStore:o,automationTypecheckModule:n,contextType:a,formulasModule:r,intl:s});!function(t){const{automationActionStore:e,automationStore:o,environment:n,transaction:a,hasError:i=!1}=t;let r=e.getParentStore();if((0,_().O9)(o)){const t=e.getParentPointer();if(!(0,_().O9)(t))throw new Error("Automation action does not have a parent pointer");if(!p().L3.isEqual(t,o.pointer))throw new Error(`Automation action parent pointer does not match argument: ${p().L3.toKey(t)}, ${p().L3.toKey(o.pointer)}`);r=o}else if(!(0,_().O9)(r))throw new Error("Automation store is undefined");h().zz({childStore:e,parentStore:r,transaction:a});const s=e.getModel();(0,_().O9)(s)&&(0,F().CM)(((t,o,a)=>{const u=(0,w().ik)(n),l=(0,F().zc)({automationActionStore:e,formulaAnalyticsModule:o,formulasModule:t,simpleFormulasModule:a});(0,_().O9)(l)&&(0,c().YO)(u,{automation_action:l,automation_action_id:s.id,automation_id:s.parent_id,has_error:i}),(0,c().gW)(u,{automation_action_id:s.id,automation_action_type:s.type,automation_id:r.id,has_error:i})}))}({automationActionStore:e,environment:i,transaction:u,hasError:(A().Q.isSuccess(l)&&l.value.actionValidationFailures[e.id]||[]).length>0}),H({automationStore:o,transaction:u,typecheckResult:l})}function $(t){const{environment:e,automationStore:o,automationTypecheckModule:n,contextType:a,formulasModule:i,intl:r,transaction:c}=t;H({automationStore:o,transaction:c,typecheckResult:(0,N().Z)({environment:e,automationStore:o,automationTypecheckModule:n,contextType:a,formulasModule:i,intl:r})})}function G(t){const{automationStore:e,transaction:o}=t;e.getSpaceId()&&e.getActionStores().forEach(((t,e)=>{var n;if(!t.isDefined())return;const a=t.getModel();a.isType("open_page")&&"url"===(null===(n=a.getConfig())||void 0===n||null===(n=n.target)||void 0===n?void 0:n.type)&&!(0,r().cQ)(e)&&T().zv({store:t.getConfigStore(),transaction:o,data:{target:null}})}))}function H(t){const{automationStore:e,transaction:o,typecheckResult:n}=t,a=e.getSpaceId(),i=e.getModel();if(a&&i&&!A().Q.isFail(n))for(const r of i.getActionIds()){const t=e.getRecordStore(e,{table:g().SC,id:r,spaceId:a});if(!t.isDefined())continue;const i=t.getModel(),c=new Set(n.value.actionInputValueTypes[r].map((t=>{if(t.kind===d().FormulaContextValueKind.Binding||t.kind===d().FormulaContextValueKind.ContextValue)return t.id;t.kind!==d().FormulaContextValueKind.ThisRow&&(0,_().HB)(t)})).filter(_().O9)),{value:u}=(0,s().G)({automationActionModel:i,baseUrl:k().A.domainBaseUrl,preventClearingConfig:!0,publicDomainName:k().A.publicDomainName,sourceSpaceId:a,visitors:{visitCollectionProperty:void 0,visitCollectionPropertyPointer:void 0,visitFormulaContextValue:t=>c.has(t)?{type:"keep"}:{type:"replace",value:void 0},visitFormulaPageProperty:void 0,visitRecordPointer:void 0}}),l=m().op.update({pointer:t.pointer,path:["config"],args:u.getConfig()??{}});I().applyOperation({store:t,operation:l,transaction:o})}}function L(t){const{environment:e,contentStore:o,transaction:n}=t,a=T().Wv({environment:e,type:"text",inMemoryRecordCache:o.inMemoryRecordCache,transaction:n,spaceId:o.pointer.spaceId});return C().BC({parentStore:o,appendStore:a,transaction:n}).childStore}function q(t){const{automationStore:e,environment:o,transaction:n}=t;T().zv({store:e,data:{status:"active"},transaction:n});const a=e.getModel();(0,_().O9)(a)&&(0,F().CM)(((t,n,i)=>{const r=(0,O().To)(e);let s=[];r&&A().Q.isSuccess(r)&&(s=r.value.valueTypes);const u=(0,w().ik)(o),l=(0,c().sp)({automationModel:a,formulaAnalyticsModule:n,formulasModule:t,formulaTypecheckContextValues:s,getRecordModel:e.getRecordModel,featureGates:(0,x().i)(),simpleFormulasModule:i});(0,c().Ah)(u,l)}))}function Y(t){const{automationStore:e,environment:o,status:n,transaction:a}=t,i=n??"disabled";T().zv({store:e,data:{status:i},transaction:a}),e.isTriggerType("recurrence")&&T().zv({store:e,data:{run_at:void 0},transaction:a});const r=e.getModel();(0,_().O9)(r)&&(0,F().CM)(((t,n,a)=>{const i=(0,O().To)(e);let s=[];i&&A().Q.isSuccess(i)&&(s=i.value.valueTypes);const u=(0,w().ik)(o),l=(0,c().sp)({automationModel:r,formulaAnalyticsModule:n,formulasModule:t,formulaTypecheckContextValues:s,getRecordModel:e.getRecordModel,featureGates:(0,x().i)(),simpleFormulasModule:a});(0,c().vN)(u,l)}))}function j(t){const{automationStore:e,environment:o,transaction:n}=t;T().zv({store:e,data:{alive:!1},transaction:n});const a=e.getModel();(0,_().O9)(a)&&(0,F().CM)(((t,n,i)=>{const r=(0,O().To)(e);let s=[];r&&A().Q.isSuccess(r)&&(s=r.value.valueTypes);const u=(0,w().ik)(o),l=(0,c().sp)({automationModel:a,formulaAnalyticsModule:n,formulasModule:t,formulaTypecheckContextValues:s,getRecordModel:e.getRecordModel,featureGates:(0,x().i)(),simpleFormulasModule:i});(0,c().Iv)(u,l)}))}},770586:(t,e,o)=>{o.d(e,{v:()=>n});o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(908872);function n(t,e){const o=t.reduce(((t,e)=>{if(e.isType("define_variables")){var o;const n=null===(o=e.getModel())||void 0===o?void 0:o.getVariables();if(n)for(const e of Object.values(n))t.add(e.name)}return t}),new Set),n=e.replace(/\s*\d+$/,"");let a=1,i=`${n} ${a}`;for(;o.has(i);)i=`${n} ${a}`,a++;return i}}}]);