"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[35599],{135599:(e,r,s)=>{s.d(r,{W:()=>Q});s(944114),s(517642),s(658004),s(733853),s(845876),s(432475),s(515024),s(731698),s(898992),s(354520),s(581454),s(737550);var t=s(296540),n=()=>s(395361),l=()=>s(484714),a=()=>s(56366),o=()=>s(721908),c=()=>s(474424),i=()=>s(591779),u=()=>s(206267),d=()=>s(207289),m=()=>s(519831),h=()=>s(245241),v=()=>s(959013),S=()=>s(496603),f=()=>s(973647),p=()=>s(534177),y=()=>s(720665),R=()=>s(449506),g=()=>s(518362),_=()=>s(989423),b=()=>s(148777),k=()=>s(825972),I=()=>s(71304),q=()=>s(780865),C=()=>s(470928),L=()=>s(722038),T=()=>s(406792),M=()=>s(106628),P=()=>s(361330),w=()=>s(109054),A=()=>s(351360),B=()=>s(227440),K=()=>s(508496),O=()=>s(968172),E=()=>s(20199),x=()=>s(558407),N=()=>s(630116),V=()=>s(645873),z=()=>s(963589),U=()=>s(531770);function F(){return{query:void 0,localResults:[],numTotalLocalResults:0,serverResults:[],numTotalServerResults:0,searchSessionId:(0,u().JW)(),isResultsLoading:!1}}function Q(e){var r;const{searchQuery:s,limit:u,source:Q,type:Y,ancestorId:X,disable:J,overrideSpaceStore:Z,overrideSearchSessionId:j,usePrefetch_EXPERIMENTAL:D,isTitleOnly:H=!0}=e,$=(0,l().v3)(),ee=(0,v().tz)(),re=(0,i().ZC)(s),se=(0,i().ZC)(e.filters),te=(0,t.useRef)({number:0,query:""}),ne=(0,t.useCallback)((e=>{const r=te.current.query.trim(),s=e.trim();""!==s&&r!==s&&(te.current.number+=1,te.current.query=s)}),[]),le=(0,n().Y)(ne,P().ab),ae=(0,t.useRef)(!0),oe=(0,a().K8)((()=>B().A.state.online),[]),ce=(0,a().K8)((()=>e.isLocalOnlyMode||!oe),[oe,e.isLocalOnlyMode]),ie=(0,L().y)(),[ue,de]=(0,t.useState)(F()),me=(0,a().K8)((()=>j&&j!==ue.searchSessionId?(de((e=>({...e,searchSessionId:j}))),j):ue.searchSessionId),[ue,j]),he=(0,z().X)("unified_find_cache_query_gen"),ve=(0,z().X)("quick_find_highlights_enabled"),{searchLocalResults:Se,searchServerResults:fe,isResultsLoading:pe,numTotalLocalResults:ye,numTotalServerResults:Re}=(0,a().K8)((()=>({searchLocalResults:ue.localResults,searchServerResults:ue.serverResults,isResultsLoading:ue.isResultsLoading,numTotalLocalResults:ue.numTotalLocalResults,numTotalServerResults:ue.numTotalServerResults})),[ue]),ge=(0,a().K8)((()=>{if(ce||pe&&ae.current)return Se;let e=function(e){const{localResults:r,serverResults:s}=e,t=r.map((e=>e.store.id)),n=new Set(t),l=s.filter((e=>!n.has(e.store.id)));return[...r,...l]}({localResults:Se,serverResults:fe});return Y===h().Vz.CollectionsInSpace&&(e=W(e)),e}),[ce,pe,Se,fe,Y]),_e=(0,a().K8)((()=>Z||A().default.state.currentSpaceStore),[Z]),be=(0,a().K8)((()=>"on"===K().default.getEligibleGroup({experimentId:"search-use-local-reranker-layered",parameter:"shouldUseLocalReranker",defaultGroup:"control"})),[]),ke=(0,a().K8)((()=>ce&&oe&&Boolean(D)),[ce,oe,D]),Ie=(0,a().K8)((()=>(0,q().Er)($).hasPublicAccessPermission),[$]),qe=(0,t.useMemo)((()=>{const r={navigableBlockContentOnly:H,...e.filters};return(0,h().N2)(r)}),[e.filters,H]),Ce=(0,t.useMemo)((()=>{var r;return function(e){const{blockTypes:r,queryType:s}=e;switch(s){case h().Vz.CollectionsInSpace:return["collection_view","collection_view_page"];case h().Vz.BlocksInCollection:return["page","collection_view_page"];case h().Vz.BlocksInSpace:default:return[...r??[]]}}({blockTypes:null===(r=e.filters)||void 0===r?void 0:r.blockTypes,queryType:Y})}),[null===(r=e.filters)||void 0===r?void 0:r.blockTypes,Y]),Le=(0,t.useCallback)(((e,r)=>{const{isSuccess:s,totalResultsCount:t,localCacheMetadata:n,query:l}=r;T().default.measure(e,{environment:$,data:{start_time:e.startTime,success:s,surface:Q,num_results:t,search_session_id:me,local_cache_metadata:n,local_cache_readiness_timings:(0,b().Yp)(),query_length:l.length}})}),[$,Q,me]),Te=(0,t.useCallback)(((e,r)=>{const{isSuccess:s,totalResultsCount:t,query:n}=r;T().default.measure(e,{environment:$,data:{start_time:e.startTime,success:s,surface:Q,num_results:t,search_session_id:me,search_session_flow_number:te.current.number,query_length:n.length}})}),[$,Q,me]),Me=(0,a().K8)((()=>E().A.state.localSearchableBlocksCache),[]),Pe=(0,V().fJ)(M().T.searchActions),we=(0,t.useCallback)((e=>{const r=T().default.mark("rum.local_quick_search_query"),{query:s,spaceStore:t}=e,n=ie&&!oe&&(0,p().Xk)(h().Iy,Q);if("resolved"!==Pe.status)return;const l=Y===h().Vz.CollectionsInSpace;let a=[];0===s.length&&l&&(a=function(e){const{spaceStore:r,environment:s}=e,t=(0,g().F)({currentUserId:s.currentUser.id,spaceId:r.id}).map((e=>{const s=N().md.createChildStore(r,{table:m().Vl,id:e}).getParentBlockStore();if(null==s?void 0:s.pathIsAccessibleAndAlive())return s}));return(0,S().oE)(t)}({environment:$,spaceStore:t}).map(((e,r)=>({store:e,originalPosition:r,id:e.id,score:0,spaceId:e.getSpaceId(),sources:[h().Ni.Local],featureGroups:[],serverEventProperties:void 0}))));const o=(0,b().PE)({environment:$,overrideCurrentUserId:$.currentUser.id,overrideSpaceId:t.id,overrideLocalSearchableBlocksCache:Me}),c=(0,U().S6)({environment:$,parentStore:t,isOnline:oe,requestInput:{query:{text:s,filters:{...qe,blockTypes:Ce,isOfflineOnly:n},sort:{field:"relevance"}},limit:ce?u:Math.min(u,5)},localSearchCache:Me,shouldUseNewRerankerDebugOverrideEnabled:be,shouldLimitLocalResultsWhenOnline:!ce,hasPublicAccessPermission:Ie}),i=ke?G({query:s,serverResults:We.current}):[],d=c&&f().Q.unwrapOr(c,void 0),v=(null==d?void 0:d.results)??[],y=(null==d?void 0:d.total)??0;let R=S().hS([...a,...v,...i],(e=>e.id));R=l?W(R):R,de((e=>e.query!==s?e:(Xe.current=R.map((e=>e.id)),Le(r,{query:s,isSuccess:Boolean(d),totalResultsCount:y,localCacheMetadata:o}),le(s),{...e,localResults:R,isResultsLoading:!ce&&e.isResultsLoading,numTotalLocalResults:y})))}),[ie,oe,Q,Pe.status,Y,$,qe,Ce,ce,u,be,Ie,ke,Le,le,Me]),Ae="mini_quick_find"===Q?40:P().GR,Be=(0,n().Y)(we,Ae),Ke=(0,t.useCallback)((e=>{R().callApi({eventName:"warmSearchQueryCache",environment:$,data:{spaceId:(null==_e?void 0:_e.id)??"",query:e.query,searchSessionId:me}})}),[$,_e,me]),Oe=(0,n().Y)(Ke,200),Ee=(0,t.useCallback)((e=>{const{result:r,isMetaClick:t,context:n}=e,l=(0,I().Qe)(r.store,ee,$,!1),a=(0,w().u)({query:s,resultText:l??"",isLastQueryTermPartialMatchOK:!0}),o=A().default.state.currentSpaceStore,c=Boolean(null==o?void 0:o.getSettings().enable_ai_training);(0,_().u4)({environment:$,event:{eventName:"select_search_item",eventProperties:{sources:r.sources,localSources:Array.from(r.localSource||new Set),searchSessionId:me,aiSessionId:void 0,searchSessionFlowNumber:te.current.number,context:n,queryStringLength:s.length,isTitleMatch:a,queryIfLeap:c?s:void 0,totalSearchResultCount:ye+Re,numLocalResults:Se.length,numTotalLocalResults:ye,isMobile:$.device.isMobile,isMetaClick:t,hasFilters:Boolean(qe),originalPosition:r.originalPosition,selectedItemIndex:r.originalPosition,selectedSearchResultMetadata:{blockId:r.id,blockType:r.store.getModel().type},searchSource:Q,verificationState:(0,C().i1)(r.store)}}})}),[$,ye,Re,Se,s,me,te,qe,Q,ee]),xe=re===s,Ne=S().n4(se,e.filters),Ve=Boolean(re&&!s),ze=Ne&&xe,Ue=!J&&_e&&!ze,Fe=Ve||!Ne,Qe=(0,t.useRef)(!1),Ge=(0,t.useRef)([]),We=(0,t.useRef)([]),Ye=(0,t.useRef)([]),Xe=(0,t.useRef)([]),Je=(0,a().K8)((()=>{if("mention_menu"!==Q)return;return x().A.getMentionedIds($.currentUser.id)}),[$.currentUser.id,Q]),Ze=(0,t.useCallback)((async e=>{const r=T().default.mark("rum.server_quick_search_query"),{query:s,spaceStore:t,size:n}=e,l=t.id;if(ce&&!ke)return;const a=!ae.current&&Ne?Ge.current:[],o=ke?G({query:s,serverResults:We.current}):[];if(ke&&(s.length<=1||o.length>=5||Ye.current.some((e=>e===s))))return;Ye.current.push(s);const i=await R().callApi({eventName:"search",environment:$,data:{...Y===h().Vz.BlocksInAncestor?{type:Y,ancestorId:X??"",spaceId:l}:{type:Y,collectionId:(null==qe?void 0:qe.parentId)??"",spaceId:l},query:s,spaceId:l,limit:"mini_quick_find"===Q?10:n+1,filters:qe,sort:{field:"relevance"},source:Q,searchSessionId:me,searchSessionFlowNumber:te.current.number,recentlyMentionedPageIds:Je,recentPagesForBoosting:(0,k().cs)(O().A.getWithoutSubscribing(l)),excludedBlockIds:S().sb([...a.map((e=>e.id)),...Xe.current||[],...We.current.map((e=>e.id))]),ignoresHighlight:!ve||"mini_quick_find"!==Q}});if(!i||"failed"===i.type)return;const u=i.data.total,m=(0,y().MU)((0,p().WP)(i.data.trackEventProperties).map((e=>{let[r,s]=e;return[`server-${r}`,s]}))),v=i.data.results.slice(0,n).map(((e,r)=>{const s=N().Bv.createChildStore(t,{id:e.id,spaceId:e.spaceId,table:"block"}),n=ke?function(e){const{result:r,store:s,environment:t}=e;if(r.terms)return r.terms;const n=s.getModel();if(!n)return[];const l=t.defaultRecordCache.inMemoryRecordCache.makeGetRecordValueFn(t.currentUser.id),a=(0,d().KM)((0,c().g)({blockValue:n,getRecordValue:l}).text);if(!a)return[];return(0,w().N)(a)}({environment:$,store:s,result:e}):e.terms;return{store:s,originalPosition:r,...e,serverEventProperties:m,terms:n}}));Qe.current=!(u<=n);const f=[...a,...v];Ge.current=f,We.current=S().hS([...ke?v:[],...We.current],(e=>e.id)),ke||(de((e=>e.query!==s?e:(Te(r,{query:s,isSuccess:"success"===i.type,totalResultsCount:u}),{...e,serverResults:f,isResultsLoading:!1,numTotalServerResults:u}))),le(s))}),[ce,ke,Ne,$,Y,X,qe,Q,me,Je,Xe,le,Te,ve]),je=(0,t.useCallback)((e=>{!J&&_e&&Qe.current&&!pe&&oe&&(de((e=>({...e,isResultsLoading:!0}))),Qe.current=!1,ae.current=!1,Ze({query:s,spaceStore:_e,size:e??20}))}),[_e,J,Ze,oe,pe,s]),De="mini_quick_find"===Q?100:P().ab,He=(0,o().d)(je,De),$e=(0,n().Y)(Ze,ke?0:P().ab);return(0,t.useEffect)((()=>{Fe&&(de((e=>({...F(),searchSessionId:e.searchSessionId}))),We.current=[],Ye.current=[]),Ue&&(ae.current=!0,de((e=>({...e,isResultsLoading:!0,query:s}))),Be({query:s,spaceStore:_e}),$e({query:s,spaceStore:_e,size:u}),"mini_quick_find"===Q&&he&&Oe({query:s}))}),[_e,Be,$e,Oe,u,s,Ue,Fe,Q,he]),{results:ge,isResultsLoading:pe,searchSessionId:me,fetchAdditionalServerResultsOnChange:!J&&!ce&&Qe.current&&ze?He:void 0,searchSessionFlowNumber:te.current.number,hasMoreResults:Qe.current,searchAnalytics:{trackSelectSearchItem:Ee}}}function G(e){const{query:r,serverResults:s}=e;return r?s.filter((e=>(0,w().u)({query:r,resultText:(e.terms??[]).join(" "),isLastQueryTermPartialMatchOK:!0}))):[]}function W(e){const r=new Set;return e.filter((e=>{const s=e.store.getCollectionViewSourceCollectionStore();return!(!s||r.has(s.id))&&(r.add(s.id),!0)}))}}}]);